{% extends "layout.html" %}
{% block content %}
  <div class="section">
    <h3>Пользователи</h3>

    {% set next_dir_created = 'asc' if sort == 'created_at' and dir == 'desc' else 'desc' %}
    {% set next_dir_balance = 'asc' if sort == 'balance' and dir == 'desc' else 'desc' %}
    {% set next_dir_last = 'asc' if sort == 'last_seen' and dir == 'desc' else 'desc' %}

    <form
      id="usersFilterForm"
      method="get"
      action="/admin/users"
      class="filter-bar"
      data-ui-async="true"
      data-ui-loading="true"
      data-toast-error="Не удалось выполнить поиск пользователей. Попробуйте ещё раз."
    >
      <div>
        <label>Поиск (Telegram ID или username)</label>
        <input name="q" value="{{ search }}" placeholder="Например: 493780829 или stepanenko" />
      </div>
      <div>
        <label>Статус</label>
        <select name="status" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
          <option value="all" {% if status == 'all' %}selected{% endif %}>Все</option>
          <option value="active" {% if status == 'active' %}selected{% endif %}>Активные</option>
          <option value="banned" {% if status == 'banned' %}selected{% endif %}>Забаненные</option>
        </select>
      </div>
      <div>
        <label>На странице</label>
        <select name="limit" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
          <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
          <option value="40" {% if per_page == 40 %}selected{% endif %}>40</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
          <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
        </select>
      </div>
      <div class="filter-bar__actions">
        <input type="hidden" name="sort" value="{{ sort }}" />
        <input type="hidden" name="dir" value="{{ dir }}" />
        <input type="hidden" name="page" value="1" />
        <button type="submit">Apply</button>
        <a
          class="filter-bar__reset"
          href="/admin/users"
          id="usersFilterReset"
          data-view-reset="users"
        >Reset</a>
      </div>
    </form>

    <div class="subtle" style="margin-bottom: 8px;">Найдено: {{ total }}</div>

    <div class="table-shell">
      <div class="table-scroll table-scroll--bounded">
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Telegram ID</th>
            <th>Username</th>
            <th>
              <a class="sort-link" href="/admin/users?q={{ search }}&status={{ status }}&sort=balance&dir={{ next_dir_balance }}&limit={{ per_page }}&page=1">
                Баланс
                {% if sort == 'balance' %}
                <span class="sort-link__caret">{{ '↑' if dir == 'asc' else '↓' }}</span>
                {% endif %}
              </a>
            </th>
            <th>Статус</th>
            <th>
              <a class="sort-link" href="/admin/users?q={{ search }}&status={{ status }}&sort=created_at&dir={{ next_dir_created }}&limit={{ per_page }}&page=1">
                Первый вход (МСК)
                {% if sort == 'created_at' %}
                <span class="sort-link__caret">{{ '↑' if dir == 'asc' else '↓' }}</span>
                {% endif %}
              </a>
            </th>
            <th>
              <a class="sort-link" href="/admin/users?q={{ search }}&status={{ status }}&sort=last_seen&dir={{ next_dir_last }}&limit={{ per_page }}&page=1">
                Последняя активность (МСК)
                {% if sort == 'last_seen' %}
                <span class="sort-link__caret">{{ '↑' if dir == 'asc' else '↓' }}</span>
                {% endif %}
              </a>
            </th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td class="cell-mono">
              <span class="truncate" title="{{ u.id }}">{{ u.id }}</span>
              <button type="button" class="copy-btn" data-copy-text="{{ u.id }}" title="Copy user id">Copy</button>
            </td>
            <td class="cell-mono">
              <span class="truncate" title="{{ u.telegram_id }}">{{ u.telegram_id }}</span>
              <button type="button" class="copy-btn" data-copy-text="{{ u.telegram_id }}" title="Copy telegram id">Copy</button>
            </td>
            <td class="muted">{{ u.username }}</td>
            <td>{{ u.balance_credits }}</td>
            <td>
              {% if u.is_banned %}
                <span class="badge danger">Забанен</span>
              {% else %}
                <span class="badge ok">Активен</span>
              {% endif %}
            </td>
            <td class="muted">{{ u.first_seen_at_msk }}</td>
            <td class="muted">{{ u.last_seen_at_msk }}</td>
            <td><a class="row-link table-action-link" href="/admin/users/{{ u.id }}">Открыть</a></td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8">
              <div class="empty-state">
                <div class="empty-state__title">Нет записей</div>
                <div class="empty-state__subtitle">Попробуйте изменить фильтры или обновить страницу</div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top: 12px; align-items:center;">
      {% if has_prev %}
        <a class="row-link" href="/admin/users?q={{ search }}&status={{ status }}&sort={{ sort }}&dir={{ dir }}&limit={{ per_page }}&page={{ prev_page }}">← Предыдущая</a>
      {% endif %}
      <span class="subtle">Страница {{ page }}</span>
      {% if has_next %}
        <a class="row-link" href="/admin/users?q={{ search }}&status={{ status }}&sort={{ sort }}&dir={{ dir }}&limit={{ per_page }}&page={{ next_page }}">Следующая →</a>
      {% endif %}
    </div>
  </div>

  <script>
    (() => {
      const form = document.getElementById('usersFilterForm');
      const reset = document.getElementById('usersFilterReset');
      const view = window.adminUi?.viewState;
      if (!form || !view) return;

      const scope = 'users';
      if (!window.location.search) {
        const stored = view.load(scope);
        if (stored && typeof stored === 'object') {
          Object.entries(stored).forEach(([key, value]) => {
            const field = form.elements.namedItem(key);
            if (!field) return;
            if (field instanceof RadioNodeList) return;
            field.value = String(value ?? '');
          });
        }
      }

      form.addEventListener('submit', () => {
        const payload = {};
        new FormData(form).forEach((value, key) => {
          payload[key] = String(value ?? '');
        });
        view.save(scope, payload);
      });

      if (reset) {
        reset.addEventListener('click', () => view.clear(scope));
      }
    })();
  </script>
{% endblock %}
