{% extends "layout.html" %}
{% block content %}
  <div class="section">
    <a class="row-link" href="/admin/promos">← Назад</a>
    <h3 class="section-title">Батч {{ batch.batch_id }}</h3>
    <div class="subtle">Создан: {{ batch.created_at }}</div>
    <div class="subtle">Кодов: {{ batch.count }} · Кредиты за код: {{ batch.credits_amount }}</div>

    <div style="height: 12px;"></div>
    <div class="card">
      <label>Скопировать все коды (по одному в строке)</label>
      <textarea id="codes" style="width:100%; min-height:120px; background:#0f1b2b; color:var(--text); border:1px solid var(--line); border-radius:8px; padding:8px;">{% for code in codes %}{{ code }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
      <div style="margin-top: 8px;">
        <button type="button" onclick="copyCodes()">Скопировать</button>
      </div>
    </div>

    <div style="height: 16px;"></div>
    <div class="table-shell">
      <div class="table-scroll table-scroll--bounded">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Код</th>
            <th>Статус</th>
            <th>Активирован</th>
            <th>Время активации (МСК)</th>
            <th>Баланс пользователя</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for row in rows %}
          <tr>
            <td class="cell-mono"><span class="truncate" title="{{ row.code }}">{{ row.code }}</span></td>
            <td>
              {% if row.status == 'redeemed' %}
                <span class="badge ok">Активирован</span>
              {% elif row.status == 'inactive' %}
                <span class="badge danger">Отключён</span>
              {% else %}
                <span class="badge">Не активирован</span>
              {% endif %}
            </td>
            <td class="muted">{{ row.redeemed_user or '—' }}</td>
            <td class="muted">{{ row.redeemed_at_msk or '—' }}</td>
            <td class="muted">{{ row.user_balance or '—' }}</td>
            <td>
              {% if row.can_deactivate and can_manage %}
                <form method="post" action="/admin/promos/code/{{ row.code }}/deactivate" data-ui-async="true" data-ui-loading="true" data-confirm-danger="true" data-confirm-title="Деактивировать промокод?" data-confirm-message="Это действие нельзя отменить." data-confirm-ok="Деактивировать" data-confirm-cancel="Отмена" data-toast-success="Промокод деактивирован.">
                  <input type="hidden" name="next" value="/admin/promos/batch/{{ batch.batch_id }}" />
                  <button type="submit">Деактивировать</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-state__title">Нет записей</div>
                <div class="empty-state__subtitle">Попробуйте изменить фильтры или обновить страницу</div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </div>
  </div>

  <script>
    function copyCodes() {
      const el = document.getElementById('codes');
      el.select();
      el.setSelectionRange(0, 999999);
      document.execCommand('copy');
    }
  </script>
{% endblock %}
