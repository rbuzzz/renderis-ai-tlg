{% extends "layout.html" %}
{% block content %}
<style>
.chat-page {
    margin-top: 0;
  }
  .chat-grid {
    display: grid;
    grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
    gap: 16px;
  }
  .chat-list {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    overflow: hidden;
    height: 72vh;
    min-height: 380px;
    display: flex;
    flex-direction: column;
  }
  .chat-list header,
  .chat-pane header {
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
  }
  .chat-pane header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .chat-header-meta {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .chat-user-link {
    font-size: 12px;
    color: var(--muted);
    text-decoration: none;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 2px 8px;
  }
  .chat-user-link:hover {
    color: var(--text);
    text-decoration: none;
  }
  .chat-delete-btn {
    background: #4a1f2a;
    color: #ffd7de;
    border: 1px solid #7e3346;
  }
  .chat-delete-btn:hover {
    background: #5a2532;
  }
  .chat-items {
    overflow-y: auto;
    flex: 1;
  }
  .chat-item {
    padding: 10px 14px;
    border-bottom: 1px solid #1d2f46;
    cursor: pointer;
  }
  .chat-item.active { background: #0f1b2b; }
  .chat-item small { color: var(--muted); display: block; margin-top: 4px; }
  .chat-pane {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    display: flex;
    flex-direction: column;
    height: 72vh;
    min-height: 380px;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 12px;
    border-radius: 10px;
    background: #0f1b2b;
    border: 1px solid #223650;
    white-space: pre-wrap;
  }
  .msg.user { align-self: flex-start; }
  .msg.admin { align-self: flex-end; background: #123b2c; border-color: #1c5e46; }
  .msg-image {
    display: block;
    width: min(100%, 340px);
    height: auto;
    border-radius: 8px;
    border: 1px solid #2b3f59;
    margin-bottom: 8px;
    background: #0b1626;
    cursor: zoom-in;
  }
  .image-preview-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(3, 8, 16, 0.88);
    z-index: 1000;
    padding: 20px;
  }
  .image-preview-modal.open {
    display: flex;
  }
  .image-preview-frame {
    position: relative;
    max-width: min(1200px, 96vw);
    max-height: 92vh;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #2b3f59;
    border-radius: 12px;
    background: #0b1626;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
    padding: 10px;
  }
  .image-preview-frame img {
    display: block;
    max-width: min(1160px, 92vw);
    max-height: 86vh;
    width: auto;
    height: auto;
    border-radius: 8px;
    object-fit: contain;
    background: #09111d;
  }
  .image-preview-close {
    position: absolute;
    top: -14px;
    right: -14px;
    width: 36px;
    height: 36px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: #13253b;
    color: var(--text);
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .image-preview-close:hover {
    background: #1a324f;
  }
  .msg small { color: var(--muted); display: block; margin-top: 6px; font-size: 11px; }
  .chat-input {
    padding: 12px 14px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    background: #13253b;
  }
  .chat-input input { flex: 1; min-width: 0; }
  .chat-input-tools {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-file-label {
    font-size: 12px;
    color: var(--muted);
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  @media (max-width: 980px) {
    .chat-grid { grid-template-columns: 1fr; }
    .chat-list {
      height: clamp(180px, 30vh, 300px);
      min-height: 180px;
    }
    .chat-pane {
      height: clamp(320px, 56vh, 620px);
      min-height: 320px;
    }
    .msg {
      max-width: 84%;
    }
  }
  @media (max-width: 640px) {
    .chat-page h3 {
      margin: 0 0 10px;
    }
    .chat-grid {
      gap: 10px;
    }
    .chat-list header,
    .chat-pane header {
      padding: 10px 12px;
      font-size: 14px;
    }
    .chat-item {
      padding: 9px 12px;
    }
    .chat-messages {
      padding: 10px;
      gap: 8px;
    }
    .msg {
      max-width: 90%;
      padding: 9px 10px;
      font-size: 14px;
    }
    .chat-input {
      position: sticky;
      bottom: 0;
      padding: 10px;
      gap: 6px;
    }
    .chat-input button {
      padding: 8px 10px;
      white-space: nowrap;
    }
  }
</style>

<div class="section chat-page">
  <h3>Ð§Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸</h3>
  <div id="chatStatus" class="subtle" style="margin-bottom: 10px;"></div>
  <div class="chat-grid">
    <div class="chat-list">
      <header>Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¸</header>
      <div class="chat-items" id="chatItems"></div>
    </div>
    <div class="chat-pane">
      <header id="chatHeader">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚</header>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input id="chatFile" type="file" accept="image/*" style="display:none;" />
        <div class="chat-input-tools">
          <button id="chatAttach" type="button">ðŸ“Ž Ð¤Ð¾Ñ‚Ð¾</button>
          <span id="chatFileName" class="chat-file-label"></span>
        </div>
        <input id="chatInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." />
        <button id="chatSend">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
      </div>
    </div>
  </div>
</div>
<div id="imagePreviewModal" class="image-preview-modal" aria-hidden="true">
  <div class="image-preview-frame">
    <button id="imagePreviewClose" type="button" class="image-preview-close" aria-label="Close">Ã—</button>
    <img id="imagePreviewImg" src="" alt="preview" />
  </div>
</div>

<script>
  const canManage = {{ "true" if can_manage else "false" }};
  const chatItems = document.getElementById('chatItems');
  const chatMessages = document.getElementById('chatMessages');
  const chatHeader = document.getElementById('chatHeader');
  const chatInput = document.getElementById('chatInput');
  const chatFile = document.getElementById('chatFile');
  const chatAttach = document.getElementById('chatAttach');
  const chatFileName = document.getElementById('chatFileName');
  const chatSend = document.getElementById('chatSend');
  const chatStatus = document.getElementById('chatStatus');
  const imagePreviewModal = document.getElementById('imagePreviewModal');
  const imagePreviewImg = document.getElementById('imagePreviewImg');
  const imagePreviewClose = document.getElementById('imagePreviewClose');
  let currentThread = null;
  let currentThreadUserId = null;
  let currentThreadLabel = '';

  function openImagePreview(src, alt) {
    if (!imagePreviewModal || !imagePreviewImg) return;
    imagePreviewImg.src = src;
    imagePreviewImg.alt = alt || 'preview';
    imagePreviewModal.classList.add('open');
    imagePreviewModal.setAttribute('aria-hidden', 'false');
  }

  function closeImagePreview() {
    if (!imagePreviewModal || !imagePreviewImg) return;
    imagePreviewModal.classList.remove('open');
    imagePreviewModal.setAttribute('aria-hidden', 'true');
    imagePreviewImg.src = '';
  }

  function setStatus(text, isError = false) {
    if (!chatStatus) return;
    chatStatus.textContent = text || '';
    chatStatus.style.color = isError ? 'var(--danger)' : 'var(--muted)';
  }

  function fmtTime(value) {
    if (!value) return '';
    const d = new Date(value);
    return d.toLocaleString();
  }

  function setFileLabel() {
    if (!chatFileName || !chatFile) return;
    const file = chatFile.files && chatFile.files[0];
    chatFileName.textContent = file ? file.name : '';
  }

  function renderChatHeader() {
    chatHeader.innerHTML = '';
    if (!currentThread) {
      chatHeader.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚';
      return;
    }
    const title = document.createElement('span');
    title.textContent = `Ð§Ð°Ñ‚: ${currentThreadLabel}`;
    chatHeader.appendChild(title);

    if (currentThreadUserId) {
      const meta = document.createElement('div');
      meta.className = 'chat-header-meta';
      const link = document.createElement('a');
      link.className = 'chat-user-link';
      link.href = `/admin/users/${currentThreadUserId}`;
      link.textContent = 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ';
      meta.appendChild(link);
      if (canManage) {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'chat-delete-btn';
        deleteBtn.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚';
        deleteBtn.onclick = deleteCurrentThread;
        meta.appendChild(deleteBtn);
      }
      chatHeader.appendChild(meta);
    }
  }

  async function deleteCurrentThread() {
    if (!canManage || !currentThread) return;
    const threadId = currentThread;
    const ok = window.confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ‡Ð°Ñ‚ Ð¸ Ð²ÑÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ? Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.');
    if (!ok) return;
    setStatus('Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‡Ð°Ñ‚...');
    let res;
    try {
      res = await fetch(`/admin/api/chats/${threadId}`, { method: 'DELETE' });
    } catch (err) {
      setStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚.', true);
      return;
    }
    if (!res.ok) {
      let error = `http_${res.status}`;
      try {
        const data = await res.json();
        error = data.error || error;
      } catch (e) {
        // ignore parse errors
      }
      setStatus(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚: ${error}`, true);
      return;
    }
    currentThread = null;
    currentThreadUserId = null;
    currentThreadLabel = '';
    chatMessages.innerHTML = '';
    renderChatHeader();
    await loadThreads();
    setStatus('Ð§Ð°Ñ‚ ÑƒÐ´Ð°Ð»Ñ‘Ð½.');
  }

  async function loadThreads() {
    let res;
    try {
      res = await fetch('/admin/api/chats');
    } catch (err) {
      setStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸.', true);
      return;
    }
    if (!res.ok) {
      setStatus(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² (${res.status})`, true);
      return;
    }
    const data = await res.json();
    chatItems.innerHTML = '';
    const threads = data.threads || [];
    if (!data.support_enabled) {
      setStatus('SUPPORT_BOT_TOKEN Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½. Ð§Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÑŽÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.', true);
    } else if (!threads.length) {
      setStatus('Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð±Ð¾Ñ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¿Ð¾ÑÐ²Ð¸Ð»Ð¸ÑÑŒ.');
    } else {
      setStatus('');
    }
    threads.forEach((t) => {
      const div = document.createElement('div');
      div.className = 'chat-item' + (currentThread === t.id ? ' active' : '');
      const title = document.createElement('strong');
      title.textContent = t.user_label;
      const time = document.createElement('small');
      time.textContent = fmtTime(t.last_message_at);
      div.appendChild(title);
      div.appendChild(time);
      if (t.user_id) {
        const profileLine = document.createElement('small');
        const profileLink = document.createElement('a');
        profileLink.className = 'row-link';
        profileLink.href = `/admin/users/${t.user_id}`;
        profileLink.textContent = 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ';
        profileLink.onclick = (e) => e.stopPropagation();
        profileLine.appendChild(profileLink);
        div.appendChild(profileLine);
      }
      div.onclick = () => selectThread(t.id, t.user_label, t.user_id);
      chatItems.appendChild(div);
    });
    if (!threads.length) {
      const empty = document.createElement('div');
      empty.className = 'chat-item';
      empty.style.cursor = 'default';
      empty.style.color = 'var(--muted)';
      empty.textContent = 'ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²';
      chatItems.appendChild(empty);
    }
    const urlParams = new URLSearchParams(window.location.search);
    const requested = urlParams.get('thread');
    if (!currentThread && threads.length) {
      const pick = requested ? threads.find((t) => String(t.id) === String(requested)) : threads[0];
      if (pick) selectThread(pick.id, pick.user_label, pick.user_id);
    }
  }

  async function loadMessages(forceScrollToBottom = false) {
    if (!currentThread) return;
    const prevScrollTop = chatMessages.scrollTop;
    const wasNearBottom =
      chatMessages.scrollHeight - (chatMessages.scrollTop + chatMessages.clientHeight) < 40;
    const res = await fetch(`/admin/api/chats/${currentThread}/messages`);
    if (!res.ok) return;
    const data = await res.json();
    const messages = data.messages || [];
    chatMessages.innerHTML = '';
    messages.forEach((m) => {
      const div = document.createElement('div');
      div.className = 'msg ' + (m.sender_type === 'admin' ? 'admin' : 'user');
      if (m.media_type === 'image' && m.media_url) {
        const img = document.createElement('img');
        img.className = 'msg-image';
        img.src = m.media_url;
        img.alt = m.media_file_name || 'image';
        img.addEventListener('click', () => openImagePreview(m.media_url, m.media_file_name || 'image'));
        div.appendChild(img);
      }
      if (m.text) {
        const text = document.createElement('div');
        text.textContent = m.text;
        div.appendChild(text);
      }
      const ts = document.createElement('small');
      ts.textContent = fmtTime(m.created_at);
      div.appendChild(ts);
      chatMessages.appendChild(div);
    });
    if (forceScrollToBottom || wasNearBottom) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } else {
      chatMessages.scrollTop = prevScrollTop;
    }
  }

  async function selectThread(threadId, label, userId) {
    currentThread = threadId;
    currentThreadLabel = label || '';
    currentThreadUserId = userId || null;
    renderChatHeader();
    await loadMessages(true);
    await loadThreads();
  }

  async function sendMessage() {
    if (!currentThread) return;
    const text = (chatInput.value || '').trim();
    const image = chatFile && chatFile.files ? chatFile.files[0] : null;
    if (!text && !image) return;
    chatSend.disabled = true;
    if (chatAttach) chatAttach.disabled = true;
    try {
      let res;
      if (image) {
        const formData = new FormData();
        formData.append('file', image);
        if (text) formData.append('caption', text);
        res = await fetch(`/admin/api/chats/${currentThread}/send-media`, {
          method: 'POST',
          body: formData,
        });
      } else {
        res = await fetch(`/admin/api/chats/${currentThread}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });
      }
      if (!res.ok) {
        let error = `http_${res.status}`;
        try {
          const data = await res.json();
          error = data.error || error;
        } catch (e) {
          // ignore parse errors
        }
        setStatus(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: ${error}`, true);
        return;
      }
      chatInput.value = '';
      if (chatFile) {
        chatFile.value = '';
      }
      setFileLabel();
      setStatus('');
      await loadMessages(true);
    } finally {
      chatSend.disabled = false;
      if (chatAttach) chatAttach.disabled = false;
    }
  }

  chatSend.onclick = sendMessage;
  if (chatAttach && chatFile) {
    chatAttach.onclick = () => chatFile.click();
    chatFile.addEventListener('change', setFileLabel);
  }
  if (imagePreviewClose) {
    imagePreviewClose.addEventListener('click', closeImagePreview);
  }
  if (imagePreviewModal) {
    imagePreviewModal.addEventListener('click', (e) => {
      if (e.target === imagePreviewModal) {
        closeImagePreview();
      }
    });
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeImagePreview();
    }
  });
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  loadThreads();
  setInterval(loadThreads, 5000);
  setInterval(loadMessages, 2000);
</script>
{% endblock %}
