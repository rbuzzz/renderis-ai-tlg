{% extends "layout.html" %}
{% block content %}
<style>
.chat-page {
    margin-top: 0;
  }
  .chat-grid {
    display: grid;
    grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
    gap: 16px;
  }
  .chat-list {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    overflow: hidden;
    height: 72vh;
    min-height: 380px;
    display: flex;
    flex-direction: column;
  }
  .chat-list header,
  .chat-pane header {
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
  }
  .chat-pane header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .chat-header-meta {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .chat-user-link {
    font-size: 12px;
    color: var(--muted);
    text-decoration: none;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 2px 8px;
  }
  .chat-user-link:hover {
    color: var(--text);
    text-decoration: none;
  }
  .chat-items {
    overflow-y: auto;
    flex: 1;
  }
  .chat-item {
    padding: 10px 14px;
    border-bottom: 1px solid #1d2f46;
    cursor: pointer;
  }
  .chat-item.active { background: #0f1b2b; }
  .chat-item small { color: var(--muted); display: block; margin-top: 4px; }
  .chat-pane {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    display: flex;
    flex-direction: column;
    height: 72vh;
    min-height: 380px;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 12px;
    border-radius: 10px;
    background: #0f1b2b;
    border: 1px solid #223650;
    white-space: pre-wrap;
  }
  .msg.user { align-self: flex-start; }
  .msg.admin { align-self: flex-end; background: #123b2c; border-color: #1c5e46; }
  .msg small { color: var(--muted); display: block; margin-top: 6px; font-size: 11px; }
  .chat-input {
    padding: 12px 14px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    background: #13253b;
  }
  .chat-input input { flex: 1; min-width: 0; }
  @media (max-width: 980px) {
    .chat-grid { grid-template-columns: 1fr; }
    .chat-list {
      height: clamp(180px, 30vh, 300px);
      min-height: 180px;
    }
    .chat-pane {
      height: clamp(320px, 56vh, 620px);
      min-height: 320px;
    }
    .msg {
      max-width: 84%;
    }
  }
  @media (max-width: 640px) {
    .chat-page h3 {
      margin: 0 0 10px;
    }
    .chat-grid {
      gap: 10px;
    }
    .chat-list header,
    .chat-pane header {
      padding: 10px 12px;
      font-size: 14px;
    }
    .chat-item {
      padding: 9px 12px;
    }
    .chat-messages {
      padding: 10px;
      gap: 8px;
    }
    .msg {
      max-width: 90%;
      padding: 9px 10px;
      font-size: 14px;
    }
    .chat-input {
      position: sticky;
      bottom: 0;
      padding: 10px;
      gap: 6px;
    }
    .chat-input button {
      padding: 8px 10px;
      white-space: nowrap;
    }
  }
</style>

<div class="section chat-page">
  <h3>Чаты поддержки</h3>
  <div id="chatStatus" class="subtle" style="margin-bottom: 10px;"></div>
  <div class="chat-grid">
    <div class="chat-list">
      <header>Диалоги</header>
      <div class="chat-items" id="chatItems"></div>
    </div>
    <div class="chat-pane">
      <header id="chatHeader">Выберите чат</header>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Введите сообщение..." />
        <button id="chatSend">Отправить</button>
      </div>
    </div>
  </div>
</div>

<script>
  const chatItems = document.getElementById('chatItems');
  const chatMessages = document.getElementById('chatMessages');
  const chatHeader = document.getElementById('chatHeader');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  const chatStatus = document.getElementById('chatStatus');
  let currentThread = null;
  let currentThreadUserId = null;
  let currentThreadLabel = '';

  function setStatus(text, isError = false) {
    if (!chatStatus) return;
    chatStatus.textContent = text || '';
    chatStatus.style.color = isError ? 'var(--danger)' : 'var(--muted)';
  }

  function fmtTime(value) {
    if (!value) return '';
    const d = new Date(value);
    return d.toLocaleString();
  }

  function renderChatHeader() {
    chatHeader.innerHTML = '';
    if (!currentThread) {
      chatHeader.textContent = 'Выберите чат';
      return;
    }
    const title = document.createElement('span');
    title.textContent = `Чат: ${currentThreadLabel}`;
    chatHeader.appendChild(title);

    if (currentThreadUserId) {
      const meta = document.createElement('div');
      meta.className = 'chat-header-meta';
      const link = document.createElement('a');
      link.className = 'chat-user-link';
      link.href = `/admin/users/${currentThreadUserId}`;
      link.textContent = 'Профиль пользователя';
      meta.appendChild(link);
      chatHeader.appendChild(meta);
    }
  }

  async function loadThreads() {
    let res;
    try {
      res = await fetch('/admin/api/chats');
    } catch (err) {
      setStatus('Не удалось загрузить диалоги.', true);
      return;
    }
    if (!res.ok) {
      setStatus(`Ошибка загрузки диалогов (${res.status})`, true);
      return;
    }
    const data = await res.json();
    chatItems.innerHTML = '';
    const threads = data.threads || [];
    if (!data.support_enabled) {
      setStatus('SUPPORT_BOT_TOKEN не настроен. Чаты поддержки не принимают сообщения.', true);
    } else if (!threads.length) {
      setStatus('Диалогов пока нет. Напишите в бот поддержки, чтобы они появились.');
    } else {
      setStatus('');
    }
    threads.forEach((t) => {
      const div = document.createElement('div');
      div.className = 'chat-item' + (currentThread === t.id ? ' active' : '');
      const title = document.createElement('strong');
      title.textContent = t.user_label;
      const time = document.createElement('small');
      time.textContent = fmtTime(t.last_message_at);
      div.appendChild(title);
      div.appendChild(time);
      if (t.user_id) {
        const profileLine = document.createElement('small');
        const profileLink = document.createElement('a');
        profileLink.className = 'row-link';
        profileLink.href = `/admin/users/${t.user_id}`;
        profileLink.textContent = 'Профиль';
        profileLink.onclick = (e) => e.stopPropagation();
        profileLine.appendChild(profileLink);
        div.appendChild(profileLine);
      }
      div.onclick = () => selectThread(t.id, t.user_label, t.user_id);
      chatItems.appendChild(div);
    });
    if (!threads.length) {
      const empty = document.createElement('div');
      empty.className = 'chat-item';
      empty.style.cursor = 'default';
      empty.style.color = 'var(--muted)';
      empty.textContent = 'Нет активных диалогов';
      chatItems.appendChild(empty);
    }
    const urlParams = new URLSearchParams(window.location.search);
    const requested = urlParams.get('thread');
    if (!currentThread && threads.length) {
      const pick = requested ? threads.find((t) => String(t.id) === String(requested)) : threads[0];
      if (pick) selectThread(pick.id, pick.user_label, pick.user_id);
    }
  }

  async function loadMessages() {
    if (!currentThread) return;
    const res = await fetch(`/admin/api/chats/${currentThread}/messages`);
    if (!res.ok) return;
    const data = await res.json();
    const messages = data.messages || [];
    chatMessages.innerHTML = '';
    messages.forEach((m) => {
      const div = document.createElement('div');
      div.className = 'msg ' + (m.sender_type === 'admin' ? 'admin' : 'user');
      div.textContent = m.text;
      const ts = document.createElement('small');
      ts.textContent = fmtTime(m.created_at);
      div.appendChild(ts);
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function selectThread(threadId, label, userId) {
    currentThread = threadId;
    currentThreadLabel = label || '';
    currentThreadUserId = userId || null;
    renderChatHeader();
    await loadMessages();
    await loadThreads();
  }

  async function sendMessage() {
    if (!currentThread) return;
    const text = (chatInput.value || '').trim();
    if (!text) return;
    chatSend.disabled = true;
    try {
      const res = await fetch(`/admin/api/chats/${currentThread}/send`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });
      if (!res.ok) {
        let error = `http_${res.status}`;
        try {
          const data = await res.json();
          error = data.error || error;
        } catch (e) {
          // ignore parse errors
        }
        setStatus(`Не удалось отправить сообщение: ${error}`, true);
        return;
      }
      chatInput.value = '';
      setStatus('');
      await loadMessages();
    } finally {
      chatSend.disabled = false;
    }
  }

  chatSend.onclick = sendMessage;
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  loadThreads();
  setInterval(loadThreads, 5000);
  setInterval(loadMessages, 2000);
</script>
{% endblock %}
