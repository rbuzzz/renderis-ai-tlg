{% extends "layout.html" %}
{% block content %}
<style>
  .chat-page {
    margin-top: 8px;
  }
  .chat-page > h3 {
    margin: 0 0 16px;
  }
  .chat-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 16px;
  }
  .chat-list {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    overflow: hidden;
    height: 70vh;
    display: flex;
    flex-direction: column;
  }
  .chat-list header,
  .chat-pane header {
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
  }
  .chat-items {
    overflow-y: auto;
    flex: 1;
  }
  .chat-item {
    padding: 10px 14px;
    border-bottom: 1px solid #1d2f46;
    cursor: pointer;
  }
  .chat-item.active { background: #0f1b2b; }
  .chat-item small { color: var(--muted); display: block; margin-top: 4px; }
  .chat-pane {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    display: flex;
    flex-direction: column;
    height: 70vh;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 12px;
    border-radius: 10px;
    background: #0f1b2b;
    border: 1px solid #223650;
    white-space: pre-wrap;
  }
  .msg.user { align-self: flex-start; }
  .msg.admin { align-self: flex-end; background: #123b2c; border-color: #1c5e46; }
  .msg small { color: var(--muted); display: block; margin-top: 6px; font-size: 11px; }
  .chat-input {
    padding: 12px 14px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
  }
  .chat-input input { flex: 1; }
  @media (max-width: 980px) {
    .chat-grid { grid-template-columns: 1fr; }
    .chat-list { height: 40vh; }
    .chat-pane { height: 50vh; }
  }
</style>

<div class="section chat-page">
  <h3>Чаты поддержки</h3>
  <div class="chat-grid">
    <div class="chat-list">
      <header>Диалоги</header>
      <div class="chat-items" id="chatItems"></div>
    </div>
    <div class="chat-pane">
      <header id="chatHeader">Выберите чат</header>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <input id="chatInput" placeholder="Введите сообщение..." />
        <button id="chatSend">Отправить</button>
      </div>
    </div>
  </div>
</div>

<script>
  const chatItems = document.getElementById('chatItems');
  const chatMessages = document.getElementById('chatMessages');
  const chatHeader = document.getElementById('chatHeader');
  const chatInput = document.getElementById('chatInput');
  const chatSend = document.getElementById('chatSend');
  let currentThread = null;

  function fmtTime(value) {
    if (!value) return '';
    const d = new Date(value);
    return d.toLocaleString();
  }

  async function loadThreads() {
    const res = await fetch('/admin/api/chats');
    if (!res.ok) return;
    const data = await res.json();
    chatItems.innerHTML = '';
    const threads = data.threads || [];
    threads.forEach((t) => {
      const div = document.createElement('div');
      div.className = 'chat-item' + (currentThread === t.id ? ' active' : '');
      div.innerHTML = `<strong>${t.user_label}</strong><small>${fmtTime(t.last_message_at)}</small>`;
      div.onclick = () => selectThread(t.id, t.user_label);
      chatItems.appendChild(div);
    });
    const urlParams = new URLSearchParams(window.location.search);
    const requested = urlParams.get('thread');
    if (!currentThread && threads.length) {
      const pick = requested ? threads.find((t) => String(t.id) === String(requested)) : threads[0];
      if (pick) selectThread(pick.id, pick.user_label);
    }
  }

  async function loadMessages() {
    if (!currentThread) return;
    const res = await fetch(`/admin/api/chats/${currentThread}/messages`);
    if (!res.ok) return;
    const data = await res.json();
    const messages = data.messages || [];
    chatMessages.innerHTML = '';
    messages.forEach((m) => {
      const div = document.createElement('div');
      div.className = 'msg ' + (m.sender_type === 'admin' ? 'admin' : 'user');
      div.textContent = m.text;
      const ts = document.createElement('small');
      ts.textContent = fmtTime(m.created_at);
      div.appendChild(ts);
      chatMessages.appendChild(div);
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  async function selectThread(threadId, label) {
    currentThread = threadId;
    chatHeader.textContent = `Чат: ${label}`;
    await loadMessages();
    await loadThreads();
  }

  async function sendMessage() {
    if (!currentThread) return;
    const text = (chatInput.value || '').trim();
    if (!text) return;
    chatSend.disabled = true;
    await fetch(`/admin/api/chats/${currentThread}/send`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text }),
    });
    chatInput.value = '';
    chatSend.disabled = false;
    await loadMessages();
  }

  chatSend.onclick = sendMessage;
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  loadThreads();
  setInterval(loadThreads, 5000);
  setInterval(loadMessages, 2000);
</script>
{% endblock %}
