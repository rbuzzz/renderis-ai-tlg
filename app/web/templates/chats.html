{% extends "layout.html" %}
{% block content %}
<style>
.chat-page {
    margin-top: 0;
  }
  .chat-grid {
    display: grid;
    grid-template-columns: minmax(260px, 320px) minmax(0, 1fr);
    gap: 16px;
  }
  .chat-list {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    overflow: hidden;
    height: 72vh;
    min-height: 380px;
    display: flex;
    flex-direction: column;
  }
  .chat-list header,
  .chat-pane header {
    padding: 12px 14px;
    border-bottom: 1px solid var(--line);
    font-weight: 700;
  }
  .chat-pane header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .chat-header-meta {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .chat-user-link {
    font-size: 12px;
    color: var(--muted);
    text-decoration: none;
    border: 1px solid var(--line);
    border-radius: 999px;
    padding: 2px 8px;
  }
  .chat-user-link:hover {
    color: var(--text);
    text-decoration: none;
  }
  .chat-delete-btn {
    background: #4a1f2a;
    color: #ffd7de;
    border: 1px solid #7e3346;
  }
  .chat-delete-btn:hover {
    background: #5a2532;
  }
  .chat-items {
    overflow-y: auto;
    flex: 1;
  }
  .chat-item {
    padding: 10px 14px;
    border-bottom: 1px solid #1d2f46;
    cursor: pointer;
  }
  .chat-item.active { background: #0f1b2b; }
  .chat-item small { color: var(--muted); display: block; margin-top: 4px; }
  .chat-pane {
    border: 1px solid var(--line);
    border-radius: 14px;
    background: #13253b;
    display: flex;
    flex-direction: column;
    height: 72vh;
    min-height: 380px;
    transition: border-color 0.15s ease, box-shadow 0.15s ease;
  }
  .chat-pane.dragover {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(92, 225, 155, 0.25) inset;
  }
  .chat-body {
    flex: 1;
    min-height: 0;
    display: flex;
  }
  .chat-main {
    flex: 1;
    min-width: 0;
    min-height: 0;
    display: flex;
    flex-direction: column;
  }
  .chat-summary {
    display: none;
    flex: 0 0 280px;
    width: 280px;
    border-left: 1px solid var(--line);
    padding: 8px;
    background: #102235;
    overflow-y: auto;
  }
  .chat-summary-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 6px;
    margin-bottom: 6px;
  }
  .chat-summary-title {
    font-size: 11px;
    color: var(--muted);
    font-weight: 700;
  }
  .chat-summary-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 4px;
  }
  .chat-summary-item {
    border: 1px solid #203651;
    border-radius: 8px;
    padding: 5px 6px;
    background: #0d1c30;
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 8px;
  }
  .chat-summary-label {
    font-size: 10px;
    color: var(--muted);
    margin-bottom: 0;
    white-space: nowrap;
  }
  .chat-summary-value {
    font-size: 11px;
    font-weight: 600;
    color: var(--text);
    word-break: break-word;
    text-align: right;
    line-height: 1.2;
    max-width: 62%;
  }
  .chat-summary .chat-user-link {
    font-size: 11px;
    padding: 1px 6px;
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 14px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .msg {
    max-width: 70%;
    padding: 10px 12px;
    border-radius: 10px;
    background: #0f1b2b;
    border: 1px solid #223650;
    white-space: pre-wrap;
  }
  .msg.user { align-self: flex-start; }
  .msg.admin { align-self: flex-end; background: #123b2c; border-color: #1c5e46; }
  .msg-image {
    display: block;
    width: min(100%, 340px);
    height: auto;
    border-radius: 8px;
    border: 1px solid #2b3f59;
    margin-bottom: 8px;
    background: #0b1626;
    cursor: zoom-in;
  }
  .image-preview-modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(3, 8, 16, 0.88);
    z-index: 1000;
    padding: 20px;
  }
  .image-preview-modal.open {
    display: flex;
  }
  .image-preview-frame {
    position: relative;
    max-width: min(1200px, 96vw);
    max-height: 92vh;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #2b3f59;
    border-radius: 12px;
    background: #0b1626;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
    padding: 10px;
  }
  .image-preview-frame img {
    display: block;
    max-width: min(1160px, 92vw);
    max-height: 86vh;
    width: auto;
    height: auto;
    border-radius: 8px;
    object-fit: contain;
    background: #09111d;
  }
  .image-preview-close {
    position: absolute;
    top: -14px;
    right: -14px;
    width: 36px;
    height: 36px;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: #13253b;
    color: var(--text);
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .image-preview-close:hover {
    background: #1a324f;
  }
  .msg small { color: var(--muted); display: block; margin-top: 6px; font-size: 11px; }
  .chat-input {
    padding: 12px 14px;
    border-top: 1px solid var(--line);
    display: flex;
    gap: 8px;
    background: #13253b;
  }
  .chat-input input { flex: 1; min-width: 0; }
  .chat-input-tools {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .chat-file-label {
    font-size: 12px;
    color: var(--muted);
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .chat-attach-preview {
    display: none;
    position: relative;
    width: 44px;
    height: 44px;
    border-radius: 8px;
    border: 1px solid #2b3f59;
    overflow: hidden;
    background: #0f1b2b;
    flex: 0 0 auto;
  }
  .chat-attach-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }
  .chat-attach-preview-clear {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 18px;
    height: 18px;
    border-radius: 999px;
    border: 1px solid #76404c;
    background: rgba(41, 10, 19, 0.9);
    color: #ffd7de;
    font-size: 13px;
    line-height: 1;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  .chat-attach-preview-clear:hover {
    background: rgba(58, 15, 27, 0.95);
  }
  @media (max-width: 980px) {
    .chat-grid { grid-template-columns: 1fr; }
    .chat-list {
      height: clamp(180px, 30vh, 300px);
      min-height: 180px;
    }
    .chat-pane {
      height: clamp(320px, 56vh, 620px);
      min-height: 320px;
    }
    .chat-body {
      flex-direction: column;
    }
    .chat-summary {
      width: auto;
      flex: 0 0 auto;
      border-left: 0;
      border-top: 1px solid var(--line);
      max-height: 180px;
    }
    .msg {
      max-width: 84%;
    }
  }
  @media (max-width: 640px) {
    .chat-page h3 {
      margin: 0 0 10px;
    }
    .chat-grid {
      gap: 10px;
    }
    .chat-list header,
    .chat-pane header {
      padding: 10px 12px;
      font-size: 14px;
    }
    .chat-item {
      padding: 9px 12px;
    }
    .chat-summary {
      padding: 7px 8px;
      max-height: 140px;
    }
    .chat-messages {
      padding: 10px;
      gap: 8px;
    }
    .msg {
      max-width: 90%;
      padding: 9px 10px;
      font-size: 14px;
    }
    .chat-input {
      position: sticky;
      bottom: 0;
      padding: 10px;
      gap: 6px;
    }
    .chat-input button {
      padding: 8px 10px;
      white-space: nowrap;
    }
  }
</style>

<div class="section chat-page">
  <h3>Ð§Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸</h3>
  <form id="chatFilters" class="filter-bar" style="margin-bottom: 10px;">
    <div>
      <label>Search (user id / telegram / username)</label>
      <input id="chatFilterQ" type="text" placeholder="e.g. 493780829 or stepanenko" />
    </div>
    <div>
      <label>Status</label>
      <select id="chatFilterStatus" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
        <option value="all">All</option>
        <option value="open">Open</option>
        <option value="closed">Closed</option>
      </select>
    </div>
    <div>
      <label>Sort</label>
      <select id="chatFilterSort" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
        <option value="updated_at">Updated</option>
        <option value="status">Status</option>
      </select>
    </div>
    <div>
      <label>Direction</label>
      <select id="chatFilterDir" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
        <option value="desc">Desc</option>
        <option value="asc">Asc</option>
      </select>
    </div>
    <div>
      <label>Per page</label>
      <select id="chatFilterLimit" style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);">
        <option value="25">25</option>
        <option value="40" selected>40</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
    </div>
    <div class="filter-bar__actions">
      <button id="chatFilterApply" type="submit">Apply</button>
      <button id="chatFilterReset" class="dirty-btn-secondary" type="button">Reset</button>
    </div>
  </form>
  <div id="chatStatus" class="subtle" style="margin-bottom: 10px;"></div>
  <div class="chat-grid">
    <div class="chat-list">
      <header>Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¸</header>
      <div class="chat-items" id="chatItems"></div>
      <div id="chatPager" class="subtle" style="padding:8px 12px; border-top:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:8px;"></div>
    </div>
    <div class="chat-pane" id="chatPane">
      <header id="chatHeader">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚</header>
      <div class="chat-body">
        <div class="chat-main">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input">
        <input id="chatFile" type="file" accept="image/*" style="display:none;" />
        <div class="chat-input-tools">
          <button id="chatAttach" type="button">ðŸ“Ž Ð¤Ð¾Ñ‚Ð¾</button>
          <div id="chatAttachPreview" class="chat-attach-preview">
            <img id="chatAttachPreviewImg" src="" alt="attachment preview" />
            <button id="chatAttachPreviewClear" type="button" class="chat-attach-preview-clear" aria-label="Remove attachment">Ã—</button>
          </div>
          <span id="chatFileName" class="chat-file-label"></span>
        </div>
        <input id="chatInput" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ..." />
        <button id="chatSend">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>
          </div>
        </div>
        <aside class="chat-summary" id="chatSummary"></aside>
      </div>
    </div>
  </div>
</div>
<div id="imagePreviewModal" class="image-preview-modal" aria-hidden="true">
  <div class="image-preview-frame">
    <button id="imagePreviewClose" type="button" class="image-preview-close" aria-label="Close">Ã—</button>
    <img id="imagePreviewImg" src="" alt="preview" />
  </div>
</div>

<script>
  const canManage = {{ "true" if can_manage else "false" }};
  const chatItems = document.getElementById('chatItems');
  const chatPane = document.getElementById('chatPane');
  const chatSummary = document.getElementById('chatSummary');
  const chatMessages = document.getElementById('chatMessages');
  const chatHeader = document.getElementById('chatHeader');
  const chatInput = document.getElementById('chatInput');
  const chatFile = document.getElementById('chatFile');
  const chatAttach = document.getElementById('chatAttach');
  const chatAttachPreview = document.getElementById('chatAttachPreview');
  const chatAttachPreviewImg = document.getElementById('chatAttachPreviewImg');
  const chatAttachPreviewClear = document.getElementById('chatAttachPreviewClear');
  const chatFileName = document.getElementById('chatFileName');
  const chatSend = document.getElementById('chatSend');
  const chatStatus = document.getElementById('chatStatus');
  const chatFilters = document.getElementById('chatFilters');
  const chatFilterQ = document.getElementById('chatFilterQ');
  const chatFilterStatus = document.getElementById('chatFilterStatus');
  const chatFilterSort = document.getElementById('chatFilterSort');
  const chatFilterDir = document.getElementById('chatFilterDir');
  const chatFilterLimit = document.getElementById('chatFilterLimit');
  const chatFilterReset = document.getElementById('chatFilterReset');
  const chatPager = document.getElementById('chatPager');
  const imagePreviewModal = document.getElementById('imagePreviewModal');
  const imagePreviewImg = document.getElementById('imagePreviewImg');
  const imagePreviewClose = document.getElementById('imagePreviewClose');
  let currentThread = null;
  let currentThreadUserId = null;
  let currentThreadLabel = '';
  let pendingImageFile = null;
  let pendingImageUrl = '';
  let dragCounter = 0;
  const adminUi = window.adminUi || null;
  const chatViewScope = 'chats';
  const defaultChatView = {
    q: '',
    status: 'all',
    sort: 'updated_at',
    dir: 'desc',
    page: 1,
    limit: 40,
  };
  let chatView = { ...defaultChatView };

  function uiErrorMessage(error, fallback = 'Operation failed. Please try again.') {
    if (adminUi?.errors?.toMessage) return adminUi.errors.toMessage(error, fallback);
    return fallback;
  }

  async function copyText(value) {
    const text = String(value || '').trim();
    if (!text) return false;
    try {
      await navigator.clipboard.writeText(text);
      return true;
    } catch (_err) {
      try {
        const area = document.createElement('textarea');
        area.value = text;
        area.setAttribute('readonly', '');
        area.style.position = 'absolute';
        area.style.left = '-9999px';
        document.body.appendChild(area);
        area.select();
        const copied = document.execCommand('copy');
        area.remove();
        return copied;
      } catch (_fallbackErr) {
        return false;
      }
    }
  }

  function saveChatViewState() {
    if (!adminUi?.viewState) return;
    adminUi.viewState.save(chatViewScope, {
      q: chatView.q || '',
      status: chatView.status || 'all',
      sort: chatView.sort || 'updated_at',
      dir: chatView.dir || 'desc',
      page: Number(chatView.page || 1),
      limit: Number(chatView.limit || 40),
    });
  }

  function restoreChatViewState() {
    const saved = adminUi?.viewState?.load ? adminUi.viewState.load(chatViewScope) : null;
    chatView = { ...defaultChatView, ...(saved || {}) };
    chatView.page = Number(chatView.page || 1);
    chatView.limit = Number(chatView.limit || defaultChatView.limit);
    if (chatFilterQ) chatFilterQ.value = chatView.q || '';
    if (chatFilterStatus) chatFilterStatus.value = chatView.status || 'all';
    if (chatFilterSort) chatFilterSort.value = chatView.sort || 'updated_at';
    if (chatFilterDir) chatFilterDir.value = chatView.dir || 'desc';
    if (chatFilterLimit) chatFilterLimit.value = String(chatView.limit || defaultChatView.limit);
  }

  function renderChatPager(meta = {}) {
    if (!chatPager) return;
    const page = Number(meta.page || chatView.page || 1);
    const perPage = Number(meta.per_page || chatView.limit || defaultChatView.limit);
    const total = Number(meta.total || 0);
    const hasPrev = Boolean(meta.has_prev);
    const hasNext = Boolean(meta.has_next);
    const from = total > 0 ? (page - 1) * perPage + 1 : 0;
    const to = total > 0 ? Math.min(page * perPage, total) : 0;
    chatPager.innerHTML = '';

    const summary = document.createElement('span');
    summary.textContent = total ? `${from}-${to} of ${total}` : 'No chats';
    chatPager.appendChild(summary);

    const controls = document.createElement('div');
    controls.style.display = 'inline-flex';
    controls.style.gap = '8px';

    const prev = document.createElement('button');
    prev.type = 'button';
    prev.className = 'dirty-btn-secondary';
    prev.textContent = 'Prev';
    prev.disabled = !hasPrev;
    prev.onclick = async () => {
      if (!hasPrev) return;
      chatView.page = Math.max(1, page - 1);
      await loadThreads();
    };

    const next = document.createElement('button');
    next.type = 'button';
    next.className = 'dirty-btn-secondary';
    next.textContent = 'Next';
    next.disabled = !hasNext;
    next.onclick = async () => {
      if (!hasNext) return;
      chatView.page = page + 1;
      await loadThreads();
    };

    controls.appendChild(prev);
    controls.appendChild(next);
    chatPager.appendChild(controls);
  }

  function bindChatFilterForm() {
    if (!chatFilters) return;
    chatFilters.addEventListener('submit', async (event) => {
      event.preventDefault();
      chatView.q = (chatFilterQ?.value || '').trim();
      chatView.status = chatFilterStatus?.value || 'all';
      chatView.sort = chatFilterSort?.value || 'updated_at';
      chatView.dir = chatFilterDir?.value || 'desc';
      chatView.limit = Number(chatFilterLimit?.value || defaultChatView.limit);
      chatView.page = 1;
      await loadThreads();
    });
    if (chatFilterLimit) {
      chatFilterLimit.addEventListener('change', async () => {
        chatView.limit = Number(chatFilterLimit.value || defaultChatView.limit);
        chatView.page = 1;
        await loadThreads();
      });
    }
    if (chatFilterReset) {
      chatFilterReset.addEventListener('click', async () => {
        chatView = { ...defaultChatView };
        if (chatFilterQ) chatFilterQ.value = '';
        if (chatFilterStatus) chatFilterStatus.value = 'all';
        if (chatFilterSort) chatFilterSort.value = 'updated_at';
        if (chatFilterDir) chatFilterDir.value = 'desc';
        if (chatFilterLimit) chatFilterLimit.value = String(defaultChatView.limit);
        if (adminUi?.viewState) adminUi.viewState.clear(chatViewScope);
        await loadThreads();
      });
    }
  }

  function openImagePreview(src, alt) {
    if (!imagePreviewModal || !imagePreviewImg) return;
    imagePreviewImg.src = src;
    imagePreviewImg.alt = alt || 'preview';
    imagePreviewModal.classList.add('open');
    imagePreviewModal.setAttribute('aria-hidden', 'false');
  }

  function closeImagePreview() {
    if (!imagePreviewModal || !imagePreviewImg) return;
    imagePreviewModal.classList.remove('open');
    imagePreviewModal.setAttribute('aria-hidden', 'true');
    imagePreviewImg.src = '';
  }

  function setStatus(text, isError = false) {
    if (!chatStatus) return;
    chatStatus.textContent = text || '';
    chatStatus.style.color = isError ? 'var(--danger)' : 'var(--muted)';
  }

  function clearChatSummary() {
    if (!chatSummary) return;
    chatSummary.style.display = 'none';
    chatSummary.innerHTML = '';
  }

  function _summaryText(value) {
    if (value === null || value === undefined || value === '') return '-';
    return String(value);
  }

  function _appendSummaryItem(grid, label, value) {
    const item = document.createElement('div');
    item.className = 'chat-summary-item';
    const l = document.createElement('div');
    l.className = 'chat-summary-label';
    l.textContent = label;
    const v = document.createElement('div');
    v.className = 'chat-summary-value';
    v.textContent = _summaryText(value);
    item.appendChild(l);
    item.appendChild(v);
    grid.appendChild(item);
  }

  function renderChatSummary(data) {
    if (!chatSummary) return;
    chatSummary.innerHTML = '';

    const head = document.createElement('div');
    head.className = 'chat-summary-head';
    const title = document.createElement('div');
    title.className = 'chat-summary-title';
    title.textContent = 'Ð¡Ð²Ð¾Ð´ÐºÐ° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ';
    head.appendChild(title);
    if (data && data.user_id) {
      const link = document.createElement('a');
      link.className = 'chat-user-link';
      link.href = `/admin/users/${data.user_id}`;
      link.textContent = 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ';
      head.appendChild(link);
    }
    chatSummary.appendChild(head);

    const grid = document.createElement('div');
    grid.className = 'chat-summary-grid';
    const username = data && data.username ? `@${data.username}` : '-';
    const status = data && data.is_banned ? 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½' : 'ÐÐºÑ‚Ð¸Ð²ÐµÐ½';
    const generations = `${_summaryText(data?.generations_total)} (ÑƒÑÐ¿: ${_summaryText(data?.generations_success)}, fail: ${_summaryText(data?.generations_fail)})`;
    const paid = `${_summaryText(data?.paid_orders_count)} Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹ / ${_summaryText(data?.paid_credits_total)} ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð²`;

    _appendSummaryItem(grid, 'Telegram ID', data?.telegram_id);
    _appendSummaryItem(grid, 'Username', username);
    _appendSummaryItem(grid, 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ', status);
    _appendSummaryItem(grid, 'Ð‘Ð°Ð»Ð°Ð½Ñ', data?.balance_credits);
    _appendSummaryItem(grid, 'Ð¡ÐºÐ¸Ð´ÐºÐ° %', data?.referral_discount_pct);
    _appendSummaryItem(grid, 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¼Ð¾', data?.active_promos_count);
    _appendSummaryItem(grid, 'Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸', generations);
    _appendSummaryItem(grid, 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ', data?.last_generation_at_msk);
    _appendSummaryItem(grid, 'ÐžÐ¿Ð»Ð°Ñ‚Ñ‹', paid);
    _appendSummaryItem(grid, 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ð°', data?.last_paid_order_at_msk);
    _appendSummaryItem(grid, 'Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ñ‡Ð°Ñ‚Ðµ', data?.thread_messages_count);
    _appendSummaryItem(grid, 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ', data?.thread_last_message_at_msk);
    _appendSummaryItem(grid, 'ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´', data?.first_seen_at_msk);
    _appendSummaryItem(grid, 'ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ', data?.last_seen_at_msk);

    chatSummary.appendChild(grid);
    chatSummary.style.display = 'block';
  }

  async function loadSummary() {
    if (!chatSummary) return;
    if (!currentThread) {
      clearChatSummary();
      return;
    }
    let res;
    try {
      res = await fetch(`/admin/api/chats/${currentThread}/summary`);
    } catch (err) {
      clearChatSummary();
      return;
    }
    if (!res.ok) {
      clearChatSummary();
      return;
    }
    const data = await res.json();
    renderChatSummary(data);
  }

  function fmtTime(value) {
    if (!value) return '';
    const d = new Date(value);
    return d.toLocaleString();
  }

  function revokePendingImageUrl() {
    if (!pendingImageUrl) return;
    try {
      URL.revokeObjectURL(pendingImageUrl);
    } catch (err) {
      // ignore cleanup errors
    }
    pendingImageUrl = '';
  }

  function setFileLabel() {
    const hasFile = !!pendingImageFile;
    if (chatFileName) {
      chatFileName.textContent = hasFile ? pendingImageFile.name : '';
    }
    if (chatAttachPreview) {
      chatAttachPreview.style.display = hasFile ? 'inline-flex' : 'none';
    }
    if (chatAttachPreviewClear) {
      chatAttachPreviewClear.disabled = !hasFile;
    }
    if (chatAttachPreviewImg) {
      if (!hasFile) {
        revokePendingImageUrl();
        chatAttachPreviewImg.removeAttribute('src');
      } else {
        revokePendingImageUrl();
        pendingImageUrl = URL.createObjectURL(pendingImageFile);
        chatAttachPreviewImg.src = pendingImageUrl;
      }
    }
  }

  function isImageFile(file) {
    return !!(file && file.type && file.type.toLowerCase().startsWith('image/'));
  }

  function syncFileInput(file) {
    if (!chatFile) return;
    if (!file) {
      chatFile.value = '';
      return;
    }
    try {
      const transfer = new DataTransfer();
      transfer.items.add(file);
      chatFile.files = transfer.files;
    } catch (err) {
      // ignore browser limitations; pendingImageFile is the source of truth
    }
  }

  function setPendingImage(file) {
    if (!isImageFile(file)) {
      setStatus('ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ.', true);
      return;
    }
    pendingImageFile = file;
    syncFileInput(file);
    setFileLabel();
    setStatus(`Ð¤Ð¾Ñ‚Ð¾ Ð¿Ñ€Ð¸ÐºÑ€ÐµÐ¿Ð»ÐµÐ½Ð¾: ${file.name}`);
  }

  function clearPendingImage() {
    pendingImageFile = null;
    syncFileInput(null);
    setFileLabel();
  }

  function extractImageFromDataTransfer(dataTransfer) {
    if (!dataTransfer) return null;
    if (dataTransfer.items && dataTransfer.items.length) {
      for (const item of dataTransfer.items) {
        if (item.kind === 'file') {
          const file = item.getAsFile();
          if (isImageFile(file)) return file;
        }
      }
    }
    if (dataTransfer.files && dataTransfer.files.length) {
      for (const file of dataTransfer.files) {
        if (isImageFile(file)) return file;
      }
    }
    return null;
  }

  function resetDragState() {
    dragCounter = 0;
    if (chatPane) {
      chatPane.classList.remove('dragover');
    }
  }

  function renderChatHeader() {
    chatHeader.innerHTML = '';
    if (!currentThread) {
      chatHeader.textContent = 'Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚';
      return;
    }
    const title = document.createElement('span');
    title.textContent = `Ð§Ð°Ñ‚: ${currentThreadLabel}`;
    chatHeader.appendChild(title);

    if (currentThreadUserId) {
      const meta = document.createElement('div');
      meta.className = 'chat-header-meta';
      const link = document.createElement('a');
      link.className = 'chat-user-link';
      link.href = `/admin/users/${currentThreadUserId}`;
      link.textContent = 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ';
      meta.appendChild(link);
      if (canManage) {
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'chat-delete-btn';
        deleteBtn.textContent = 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚';
        deleteBtn.onclick = deleteCurrentThread;
        meta.appendChild(deleteBtn);
      }
      chatHeader.appendChild(meta);
    }
  }

  async function deleteCurrentThread() {
    if (!canManage || !currentThread) return;
    const threadId = currentThread;
    const ok = adminUi?.confirmModal
      ? await adminUi.confirmModal({
          title: 'Delete this chat?',
          message: 'All messages in this chat will be removed.',
          confirmText: 'Delete',
          cancelText: 'Cancel',
          variant: 'danger',
        })
      : window.confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ‡Ð°Ñ‚ Ð¸ Ð²ÑÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ? Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.');
    if (!ok) return;
    setStatus('Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‡Ð°Ñ‚...');
    const loadKey = `chat-delete:${threadId}:${Date.now()}`;
    if (adminUi?.loading) adminUi.loading.start(loadKey);
    let res;
    try {
      res = await fetch(`/admin/api/chats/${threadId}`, { method: 'DELETE' });
    } catch (err) {
      setStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚.', true);
      if (adminUi?.toast) adminUi.toast.error(uiErrorMessage(err, 'Could not delete chat.'));
      return;
    } finally {
      if (adminUi?.loading) adminUi.loading.stop(loadKey);
    }
    if (!res.ok) {
      let error = `http_${res.status}`;
      try {
        const data = await res.json();
        error = data.error || error;
      } catch (e) {
        // ignore parse errors
      }
      setStatus(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‡Ð°Ñ‚: ${error}`, true);
      if (adminUi?.toast) adminUi.toast.error(uiErrorMessage(error, 'Could not delete chat.'));
      return;
    }
    currentThread = null;
    currentThreadUserId = null;
    currentThreadLabel = '';
    chatMessages.innerHTML = '';
    clearChatSummary();
    renderChatHeader();
    await loadThreads();
    setStatus('Ð§Ð°Ñ‚ ÑƒÐ´Ð°Ð»Ñ‘Ð½.');
    if (adminUi?.toast) adminUi.toast.success('Chat deleted.');
  }

  function handlePasteImage(event) {
    if (!currentThread) return;
    const file = extractImageFromDataTransfer(event.clipboardData);
    if (!file) return;
    event.preventDefault();
    setPendingImage(file);
  }

  function handleDragEnter(event) {
    if (!chatPane) return;
    event.preventDefault();
    event.stopPropagation();
    dragCounter += 1;
    chatPane.classList.add('dragover');
  }

  function handleDragOver(event) {
    if (!chatPane) return;
    event.preventDefault();
    event.stopPropagation();
    chatPane.classList.add('dragover');
  }

  function handleDragLeave(event) {
    if (!chatPane) return;
    event.preventDefault();
    event.stopPropagation();
    dragCounter = Math.max(0, dragCounter - 1);
    if (dragCounter === 0) {
      chatPane.classList.remove('dragover');
    }
  }

  function handleDropImage(event) {
    if (!chatPane) return;
    event.preventDefault();
    event.stopPropagation();
    resetDragState();
    if (!currentThread) {
      setStatus('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‡Ð°Ñ‚.', true);
      return;
    }
    const file = extractImageFromDataTransfer(event.dataTransfer);
    if (!file) {
      setStatus('ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ (PNG/JPG/WebP/GIF/BMP).', true);
      return;
    }
    setPendingImage(file);
  }

  async function loadThreads() {
    const query = new URLSearchParams();
    if (chatView.q) query.set('q', chatView.q);
    if (chatView.status && chatView.status !== 'all') query.set('status', chatView.status);
    query.set('sort', chatView.sort || 'updated_at');
    query.set('dir', chatView.dir || 'desc');
    query.set('page', String(chatView.page || 1));
    query.set('limit', String(chatView.limit || 40));
    let res;
    try {
      res = await fetch(`/admin/api/chats?${query.toString()}`);
    } catch (err) {
      setStatus('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¸.', true);
      return;
    }
    if (!res.ok) {
      setStatus(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² (${res.status})`, true);
      return;
    }
    const data = await res.json();
    chatView.q = String(data.q ?? chatView.q ?? '');
    chatView.status = String(data.status ?? chatView.status ?? 'all');
    chatView.sort = String(data.sort ?? chatView.sort ?? 'updated_at');
    chatView.dir = String(data.dir ?? chatView.dir ?? 'desc');
    chatView.page = Number(data.page || chatView.page || 1);
    chatView.limit = Number(data.per_page || chatView.limit || defaultChatView.limit);
    if (chatFilterQ) chatFilterQ.value = chatView.q;
    if (chatFilterStatus) chatFilterStatus.value = chatView.status || 'all';
    if (chatFilterSort) chatFilterSort.value = chatView.sort || 'updated_at';
    if (chatFilterDir) chatFilterDir.value = chatView.dir || 'desc';
    if (chatFilterLimit) chatFilterLimit.value = String(chatView.limit || defaultChatView.limit);
    renderChatPager(data);
    chatItems.innerHTML = '';
    const threads = data.threads || [];
    if (!data.support_enabled) {
      setStatus('SUPPORT_BOT_TOKEN Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½. Ð§Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°ÑŽÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.', true);
    } else if (!threads.length) {
      setStatus('Ð”Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð² Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚. ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð² Ð±Ð¾Ñ‚ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½Ð¸ Ð¿Ð¾ÑÐ²Ð¸Ð»Ð¸ÑÑŒ.');
    } else {
      setStatus('');
    }
    threads.forEach((t) => {
      const div = document.createElement('div');
      div.className = 'chat-item' + (currentThread === t.id ? ' active' : '');
      const title = document.createElement('strong');
      title.textContent = t.user_label;
      const time = document.createElement('small');
      time.textContent = fmtTime(t.last_message_at);
      div.appendChild(title);
      div.appendChild(time);
      const metaLine = document.createElement('small');
      metaLine.className = 'subtle';
      const threadId = String(t.id);
      const tgId = t.telegram_id ? String(t.telegram_id) : '';
      metaLine.textContent = `Thread ${threadId}${tgId ? ` Â· TG ${tgId}` : ''}`;
      const copyThread = document.createElement('button');
      copyThread.type = 'button';
      copyThread.className = 'copy-btn';
      copyThread.setAttribute('data-copy-text', threadId);
      copyThread.textContent = 'Copy';
      copyThread.title = 'Copy thread id';
      copyThread.addEventListener('click', async (event) => {
        event.preventDefault();
        event.stopPropagation();
        const copied = await copyText(threadId);
        if (copied) adminUi?.toast?.success('Copied');
        else adminUi?.toast?.error('Could not copy');
      });
      metaLine.appendChild(copyThread);
      div.appendChild(metaLine);
      if (t.user_id) {
        const profileLine = document.createElement('small');
        const profileLink = document.createElement('a');
        profileLink.className = 'row-link';
        profileLink.href = `/admin/users/${t.user_id}`;
        profileLink.textContent = 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ';
        profileLink.onclick = (e) => e.stopPropagation();
        profileLine.appendChild(profileLink);
        div.appendChild(profileLine);
      }
      div.onclick = () => selectThread(t.id, t.user_label, t.user_id);
      chatItems.appendChild(div);
    });
    if (!threads.length) {
      const empty = document.createElement('div');
      empty.className = 'chat-item';
      empty.style.cursor = 'default';
      empty.style.color = 'var(--muted)';
      empty.textContent = 'ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð¸Ð°Ð»Ð¾Ð³Ð¾Ð²';
      chatItems.appendChild(empty);
    }
    if (currentThread && !threads.some((t) => Number(t.id) === Number(currentThread))) {
      currentThread = null;
      currentThreadUserId = null;
      currentThreadLabel = '';
      chatMessages.innerHTML = '';
      clearChatSummary();
      renderChatHeader();
    }
    const urlParams = new URLSearchParams(window.location.search);
    const requested = urlParams.get('thread');
    if (!currentThread && threads.length) {
      const pick = requested ? threads.find((t) => String(t.id) === String(requested)) : threads[0];
      if (pick) selectThread(pick.id, pick.user_label, pick.user_id);
    }
    saveChatViewState();
  }

  async function loadMessages(forceScrollToBottom = false) {
    if (!currentThread) return;
    const prevScrollTop = chatMessages.scrollTop;
    const wasNearBottom =
      chatMessages.scrollHeight - (chatMessages.scrollTop + chatMessages.clientHeight) < 40;
    const res = await fetch(`/admin/api/chats/${currentThread}/messages`);
    if (!res.ok) return;
    const data = await res.json();
    const messages = data.messages || [];
    chatMessages.innerHTML = '';
    messages.forEach((m) => {
      const div = document.createElement('div');
      div.className = 'msg ' + (m.sender_type === 'admin' ? 'admin' : 'user');
      if (m.media_type === 'image' && m.media_url) {
        const img = document.createElement('img');
        img.className = 'msg-image';
        img.src = m.media_url;
        img.alt = m.media_file_name || 'image';
        img.addEventListener('click', () => openImagePreview(m.media_url, m.media_file_name || 'image'));
        div.appendChild(img);
      }
      if (m.text) {
        const text = document.createElement('div');
        text.textContent = m.text;
        div.appendChild(text);
      }
      const ts = document.createElement('small');
      ts.textContent = fmtTime(m.created_at);
      div.appendChild(ts);
      chatMessages.appendChild(div);
    });
    if (forceScrollToBottom || wasNearBottom) {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    } else {
      chatMessages.scrollTop = prevScrollTop;
    }
  }

  async function selectThread(threadId, label, userId) {
    currentThread = threadId;
    currentThreadLabel = label || '';
    currentThreadUserId = userId || null;
    clearPendingImage();
    resetDragState();
    renderChatHeader();
    await loadMessages(true);
    await loadSummary();
    await loadThreads();
  }

  async function sendMessage() {
    if (!currentThread) return;
    const text = (chatInput.value || '').trim();
    const image = pendingImageFile;
    if (!text && !image) return;
    chatSend.disabled = true;
    if (chatAttach) chatAttach.disabled = true;
    const loadKey = `chat-send:${currentThread}:${Date.now()}`;
    if (adminUi?.loading) adminUi.loading.start(loadKey);
    try {
      let res;
      if (image) {
        const formData = new FormData();
        formData.append('file', image);
        if (text) formData.append('caption', text);
        res = await fetch(`/admin/api/chats/${currentThread}/send-media`, {
          method: 'POST',
          body: formData,
        });
      } else {
        res = await fetch(`/admin/api/chats/${currentThread}/send`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text }),
        });
      }
      if (!res.ok) {
        let error = `http_${res.status}`;
        try {
          const data = await res.json();
          error = data.error || error;
        } catch (e) {
          // ignore parse errors
        }
        setStatus(`ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: ${error}`, true);
        if (adminUi?.toast) adminUi.toast.error(uiErrorMessage(error, 'Could not send message.'));
        return;
      }
      chatInput.value = '';
      clearPendingImage();
      setStatus('');
      await loadMessages(true);
      await loadSummary();
      if (adminUi?.toast) adminUi.toast.success('Message sent.');
    } finally {
      if (adminUi?.loading) adminUi.loading.stop(loadKey);
      chatSend.disabled = false;
      if (chatAttach) chatAttach.disabled = false;
    }
  }

  chatSend.onclick = sendMessage;
  if (chatAttach && chatFile) {
    chatAttach.onclick = () => chatFile.click();
    chatFile.addEventListener('change', () => {
      const file = chatFile.files && chatFile.files[0] ? chatFile.files[0] : null;
      if (!file) {
        clearPendingImage();
        return;
      }
      setPendingImage(file);
    });
  }
  if (chatAttachPreviewClear) {
    chatAttachPreviewClear.addEventListener('click', () => {
      clearPendingImage();
      setStatus('Ð’Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾.');
    });
  }
  if (chatInput) {
    chatInput.addEventListener('paste', handlePasteImage);
  }
  if (chatPane) {
    chatPane.addEventListener('paste', handlePasteImage);
    chatPane.addEventListener('dragenter', handleDragEnter);
    chatPane.addEventListener('dragover', handleDragOver);
    chatPane.addEventListener('dragleave', handleDragLeave);
    chatPane.addEventListener('drop', handleDropImage);
  }
  if (imagePreviewClose) {
    imagePreviewClose.addEventListener('click', closeImagePreview);
  }
  if (imagePreviewModal) {
    imagePreviewModal.addEventListener('click', (e) => {
      if (e.target === imagePreviewModal) {
        closeImagePreview();
      }
    });
  }
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      closeImagePreview();
    }
  });
  window.addEventListener('beforeunload', () => {
    revokePendingImageUrl();
  });
  chatInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendMessage();
    }
  });

  restoreChatViewState();
  bindChatFilterForm();
  loadThreads();
  setInterval(loadThreads, 5000);
  setInterval(loadMessages, 2000);
  setInterval(loadSummary, 10000);
</script>
{% endblock %}
