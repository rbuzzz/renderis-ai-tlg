{% extends "layout.html" %}
{% block content %}
  <div class="section">
    <h3>Общие настройки Renderis</h3>
    {% if saved %}
    <div class="notice">Настройки сохранены.</div>
    {% endif %}
    {% if error %}
    <div style="color: var(--danger); font-size: 13px; margin-bottom: 8px;">
      Ошибка загрузки логотипа: {{ error }}.
      Допустимы изображения PNG/JPG/JPEG/WEBP/SVG/ICO/GIF/BMP/AVIF/HEIC/HEIF/JFIF, размер до {{ logo_max_size_mb }} MB.
    </div>
    {% endif %}
    {% if brain_runtime_error %}
    <div style="color: #f5c26b; font-size: 13px; margin-bottom: 8px;">
      AI Brain сейчас недоступен (проверьте миграции и таблицы в рабочей БД). Остальные настройки работают.
    </div>
    {% endif %}
    {% if not can_manage %}
    <div class="notice" style="color: var(--muted);">Режим только просмотра: изменение настроек недоступно для субадмина.</div>
    {% endif %}
    <form method="post" action="/admin/settings" enctype="multipart/form-data">
      <p class="muted" style="margin-top: 6px;">
        Формула: стоимость 1 кредита Renderis (USD) = стоимость 1 звезды (USD) × звезд за 1 кредит.
      </p>
      <div class="form-row">
        <div>
          <label>Звезд за 1 кредит</label>
          <input name="stars_per_credit" value="{{ stars_per_credit }}" />
        </div>
        <div>
          <label>Стоимость 1 звезды (USD)</label>
          <input name="usd_per_star" value="{{ usd_per_star }}" />
        </div>
        <div>
          <label>Стоимость 1 кредита Renderis (USD)</label>
          <input value="{{ usd_per_credit }}" readonly />
        </div>
        <div>
          <label>Стоимость 1 кредита Kie (USD)</label>
          <input name="kie_usd_per_credit" value="{{ kie_usd_per_credit }}" />
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Стартовый баланс нового пользователя (кредиты)</label>
          <input name="signup_bonus_credits" value="{{ signup_bonus_credits }}" />
        </div>
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">Баланс Kie</h3>
      <div class="form-row">
        <div>
          <label>Установить баланс Kie (кредиты)</label>
          <input name="set_kie_balance" placeholder="Например 840" />
        </div>
        <div>
          <label>Добавить кредиты Kie</label>
          <input name="add_kie_credits" placeholder="Например 1000" />
        </div>
        <div>
          <label>Текущий баланс (кредиты)</label>
          <input value="{{ kie_balance_credits }}" readonly />
        </div>
        <div>
          <label>Баланс (USD)</label>
          <input value="{{ kie_balance_usd }}" readonly />
        </div>
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">Оповещения по балансу</h3>
      <p class="muted" style="margin-top: 6px;">
        При снижении ниже порога бот отправит уведомление администраторам. Уровни: зелёный → жёлтый → красный.
      </p>
      <div class="form-row">
        <div>
          <label>Зелёный порог (кредиты)</label>
          <input name="kie_warn_green" value="{{ kie_warn_green }}" />
        </div>
        <div>
          <label>Жёлтый порог (кредиты)</label>
          <input name="kie_warn_yellow" value="{{ kie_warn_yellow }}" />
        </div>
        <div>
          <label>Красный порог (кредиты)</label>
          <input name="kie_warn_red" value="{{ kie_warn_red }}" />
        </div>
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">Логотип в веб-интерфейсе</h3>
      <p class="muted" style="margin-top: 6px;">
        Поддержка PNG/JPG/WEBP/SVG, до {{ logo_max_size_mb }} MB.
      </p>
      <div class="form-row">
        <div>
          <label>Загрузить новый логотип</label>
          <input type="file" name="logo_file" accept=".png,.jpg,.jpeg,.webp,.svg,image/*" />
        </div>
        <div>
          <label>Удалить текущий логотип</label>
          <label style="display: inline-flex; align-items: center; gap: 8px; margin-top: 8px;">
            <input type="checkbox" name="remove_logo" value="1" style="width: auto;" />
            <span class="muted" style="font-size: 13px;">Удалить лого при сохранении</span>
          </label>
        </div>
        {% if site_logo_url %}
        <div style="grid-column: 1 / -1;">
          <label>Текущий логотип</label>
          <div style="border: 1px solid #2b3f59; background: #0f1b2b; border-radius: 12px; padding: 12px;">
            <img
              src="{{ site_logo_url }}"
              alt="Site logo"
              style="display: block; max-height: 64px; width: auto; border-radius: 8px;"
            />
          </div>
        </div>
        {% endif %}
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">Логотип для фавикона</h3>
      <p class="muted" style="margin-top: 6px;">
        Отдельная иконка для вкладки браузера (будет со скруглёнными углами). Поддержка PNG/JPG/WEBP/SVG, до {{ logo_max_size_mb }} MB.
      </p>
      <div class="form-row">
        <div>
          <label>Загрузить логотип фавикона</label>
          <input type="file" name="favicon_file" accept=".png,.jpg,.jpeg,.webp,.svg,image/*" />
        </div>
        <div>
          <label>Удалить текущий фавикон-логотип</label>
          <label style="display: inline-flex; align-items: center; gap: 8px; margin-top: 8px;">
            <input type="checkbox" name="remove_favicon_logo" value="1" style="width: auto;" />
            <span class="muted" style="font-size: 13px;">Удалить при сохранении</span>
          </label>
        </div>
        {% if favicon_logo_url %}
        <div style="grid-column: 1 / -1;">
          <label>Текущий логотип фавикона</label>
          <div style="border: 1px solid #2b3f59; background: #0f1b2b; border-radius: 12px; padding: 12px;">
            <img
              src="{{ favicon_logo_url }}"
              alt="Favicon logo"
              style="display: block; width: 64px; height: 64px; object-fit: cover; border-radius: 12px;"
            />
          </div>
        </div>
        {% endif %}
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">AI Brain Settings</h3>
      <p class="muted" style="margin-top: 6px;">
        Улучшение промптов через OpenAI на backend. Ключ хранится только в env.
      </p>
      <div class="form-row">
        <div>
          <label>Статус OpenAI API ключа</label>
          <input value="{% if openai_key_configured %}Настроен{% else %}Не настроен{% endif %}" readonly />
        </div>
        <div>
          <label>OpenAI Base URL</label>
          <input value="{{ openai_base_url }}" readonly />
        </div>
        <div>
          <label>Включить AI Brain</label>
          <label style="display: inline-flex; align-items: center; gap: 8px; margin-top: 8px;">
            <input type="checkbox" name="ai_brain_enabled" value="1" style="width: auto;" {% if ai_brain_enabled %}checked{% endif %} />
            <span class="muted" style="font-size: 13px;">Функция улучшения промпта активна</span>
          </label>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>OpenAI model</label>
          <input name="ai_brain_model" value="{{ ai_brain_model }}" />
        </div>
        <div>
          <label>Temperature</label>
          <input name="ai_brain_temperature" value="{{ ai_brain_temperature }}" />
        </div>
        <div>
          <label>Max tokens</label>
          <input name="ai_brain_max_tokens" value="{{ ai_brain_max_tokens }}" />
        </div>
        <div>
          <label>Цена за улучшение (кредиты)</label>
          <input name="ai_brain_price_per_improve" value="{{ ai_brain_price_per_improve }}" />
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>Дневной лимит на пользователя</label>
          <input name="ai_brain_daily_limit_per_user" value="{{ ai_brain_daily_limit_per_user }}" />
        </div>
        <div>
          <label>Цена пакета улучшений (кредиты)</label>
          <input name="ai_brain_pack_price_credits" value="{{ ai_brain_pack_price_credits }}" />
        </div>
        <div>
          <label>Размер пакета (улучшений)</label>
          <input name="ai_brain_pack_size_improvements" value="{{ ai_brain_pack_size_improvements }}" />
        </div>
      </div>
      <div style="margin-top: 10px;">
        <label>System prompt</label>
        <textarea
          name="ai_brain_system_prompt"
          rows="4"
          style="width: 100%; padding: 8px 10px; border-radius: 8px; border: 1px solid #2b3f59; background: #0f1b2b; color: var(--text); resize: vertical;"
        >{{ ai_brain_system_prompt }}</textarea>
      </div>

      <div style="height: 16px;"></div>
      <h3 style="margin: 0 0 8px;">Занятое место в хранилище</h3>
      <p class="muted" style="margin-top: 6px;">
        Путь: <code>{{ storage_usage.root_path }}</code>
      </p>
      {% if storage_usage.available %}
      <div class="table-shell">
        <div class="table-scroll">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Категория</th>
              <th>Объем</th>
              <th>Файлов</th>
            </tr>
          </thead>
          <tbody>
            {% for row in storage_usage.categories %}
            <tr>
              <td>{{ row.title }}</td>
              <td><b>{{ row.size_human }}</b></td>
              <td>{{ row.files_count }}</td>
            </tr>
            {% endfor %}
            <tr>
              <td><b>Итого</b></td>
              <td><b>{{ storage_usage.total_human }}</b></td>
              <td><b>{{ storage_usage.total_files }}</b></td>
            </tr>
          </tbody>
        </table>
        </div>
      </div>
      {% else %}
      <div class="notice" style="color: var(--danger);">
        Не удалось прочитать хранилище ({{ storage_usage.error or "unknown" }}).
      </div>
      {% endif %}
      <div style="margin-top: 12px;">
        {% if can_manage %}
        <button type="submit">Сохранить</button>
        {% endif %}
      </div>
    </form>
  </div>
  {% if not can_manage %}
  <script>
    (function () {
      const form = document.querySelector('form[action="/admin/settings"]');
      if (!form) return;
      form.querySelectorAll("input, select, textarea, button").forEach((el) => {
        if (el.type === "submit") return;
        el.disabled = true;
      });
    })();
  </script>
  {% endif %}
{% endblock %}

