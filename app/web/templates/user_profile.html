{% extends "layout.html" %}
{% block content %}
  <div class="section">
    <a class="row-link" href="/admin/users">← Назад к пользователям</a>
    <h3 class="section-title">Профиль пользователя</h3>
    {% if saved == "banned" %}
      <div class="notice">Пользователь забанен.</div>
    {% elif saved == "unbanned" %}
      <div class="notice">Бан снят.</div>
    {% elif saved == "credits_added" %}
      <div class="notice">Кредиты успешно начислены.</div>
    {% elif saved == "credits_subtracted" %}
      <div class="notice">Кредиты успешно списаны.</div>
    {% elif saved == "balance_set" %}
      <div class="notice">Баланс установлен.</div>
    {% elif saved == "balance_unchanged" %}
      <div class="notice">Баланс не изменился.</div>
    {% elif saved == "promo_revoked" %}
      <div class="notice">Промокод отменен, кредиты списаны.</div>
    {% endif %}
    {% if error == "invalid_amount" %}
      <div class="notice" style="color: var(--danger);">Введите корректное количество кредитов (&gt; 0).</div>
    {% elif error == "invalid_balance" %}
      <div class="notice" style="color: var(--danger);">Введите корректный баланс (0 или больше).</div>
    {% elif error == "insufficient_balance" %}
      <div class="notice" style="color: var(--danger);">Недостаточно кредитов для списания.</div>
    {% elif error == "promo_not_found" %}
      <div class="notice" style="color: var(--danger);">Промокод не найден у этого пользователя.</div>
    {% elif error == "promo_already_revoked" %}
      <div class="notice" style="color: var(--danger);">Этот промокод уже отменен.</div>
    {% endif %}
    {% if not can_manage %}
      <div class="notice" style="color: var(--muted);">Режим только просмотра: изменение статуса, баланса и промо-кодов недоступно для субадмина.</div>
    {% endif %}
    <div class="grid">
      <div class="card">
        <h3>Telegram ID</h3>
        <div class="value">{{ user.telegram_id }}</div>
        <div class="subtle">Username: {{ user.username }}</div>
      </div>
      <div class="card">
        <h3>Баланс</h3>
        <div class="value">{{ user.balance_credits }}</div>
      </div>
      <div class="card">
        <h3>Статус</h3>
        <div class="value">
          {% if user.is_banned %}
            <span class="badge danger">Забанен</span>
          {% else %}
            <span class="badge ok">Активен</span>
          {% endif %}
        </div>
      </div>
      <div class="card">
        <h3>Активность</h3>
        <div class="subtle">Первый вход: {{ user.first_seen_at_msk }}</div>
        <div class="subtle">Последний вход: {{ user.last_seen_at_msk }}</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Действия</h3>
    <div class="grid" style="margin-bottom: 0;">
      <div class="card">
        <h3>Статус доступа</h3>
        {% if user.is_banned %}
          <div class="subtle" style="margin-bottom: 10px;">Пользователь сейчас забанен.</div>
          <form method="post" action="/admin/users/{{ user.id }}/unban">
            <button type="submit">Снять бан</button>
          </form>
        {% else %}
          <div class="subtle" style="margin-bottom: 10px;">Пользователь активен.</div>
          <form method="post" action="/admin/users/{{ user.id }}/ban">
            <button type="submit" style="background: var(--danger); color: #fff;">Забанить</button>
          </form>
        {% endif %}
      </div>

      <div class="card">
        <h3>Начислить кредиты</h3>
        <form method="post" action="/admin/users/{{ user.id }}/credits/add">
          <label for="credits_add">Количество</label>
          <input id="credits_add" name="amount" type="number" min="1" step="1" placeholder="Например: 50" />
          <div style="margin-top: 10px;">
            <button type="submit">Начислить</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Списать кредиты</h3>
        <form method="post" action="/admin/users/{{ user.id }}/credits/subtract">
          <label for="credits_subtract">Количество</label>
          <input id="credits_subtract" name="amount" type="number" min="1" step="1" placeholder="Например: 20" />
          <div style="margin-top: 10px;">
            <button type="submit">Списать</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h3>Установить баланс</h3>
        <form method="post" action="/admin/users/{{ user.id }}/credits/set">
          <label for="credits_set">Новый баланс</label>
          <input
            id="credits_set"
            name="balance"
            type="number"
            min="0"
            step="1"
            value="{{ user.balance_credits }}"
            placeholder="Например: 100"
          />
          <div style="margin-top: 10px;">
            <button type="submit">Установить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>История пополнений (Orders)</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Тип</th>
            <th>Stars</th>
            <th>Кредиты</th>
            <th>Статус</th>
            <th>Payload</th>
            <th>Время (МСК)</th>
          </tr>
        </thead>
        <tbody>
          {% for o in orders %}
          <tr>
            <td>{{ o.id }}</td>
            <td>{{ o.payment_kind }}</td>
            <td>{{ o.stars_amount }}</td>
            <td>{{ o.credits_amount }}</td>
            <td>{{ o.status }}</td>
            <td class="muted">{{ o.payload }}</td>
            <td class="muted">{{ o.created_at_msk }}</td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="muted">Данных нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>История баланса (Ledger)</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Δ Кредиты</th>
            <th>Причина</th>
            <th>Meta</th>
            <th>Время (МСК)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in ledger %}
          <tr>
            <td>{{ row.id }}</td>
            <td>
              {% if row.delta >= 0 %}+{% endif %}{{ row.delta }}
            </td>
            <td>{{ row.reason }}</td>
            <td class="muted">{{ row.meta }}</td>
            <td class="muted">{{ row.created_at_msk }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="muted">Данных нет</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="section">
    <h3>Активированные промо-коды</h3>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Код</th>
            <th>Кредитов</th>
            <th>Батч</th>
            <th>Активирован (МСК)</th>
            <th>Статус</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for p in promo_codes %}
          <tr>
            <td>{{ p.code }}</td>
            <td>{{ p.credits_amount }}</td>
            <td>{{ p.batch_id }}</td>
            <td class="muted">{{ p.redeemed_at_msk }}</td>
            <td>
              {% if p.active %}
                <span class="badge ok">Активен</span>
              {% else %}
                <span class="badge warn">Отменен</span>
              {% endif %}
            </td>
            <td>
              {% if p.active %}
                <form method="post" action="/admin/users/{{ user.id }}/promos/{{ p.code }}/revoke">
                  <button type="submit" style="background: var(--danger); color: #fff;">Отменить</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="muted">Нет активированных промо-кодов</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% if not can_manage %}
  <div class="section">
    <h3>Предложение админу</h3>
    <div class="subtle" style="margin-bottom: 10px;">
      Создайте черновик изменения по этому пользователю и отправьте на согласование.
    </div>
    <form method="post" action="/admin/change-requests/create" id="profile-request-form">
      <input type="hidden" name="target_user_id" value="{{ user.id }}" />
      <div class="form-row">
        <div>
          <label for="profile_change_type">Тип изменения</label>
          <select
            id="profile_change_type"
            name="change_type"
            required
            style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);"
          >
            <option value="add_credits">Начислить кредиты</option>
            <option value="subtract_credits">Списать кредиты</option>
            <option value="set_balance">Установить баланс</option>
            <option value="revoke_promo">Отозвать промо-код</option>
          </select>
        </div>
        <div id="profile_credits_wrap">
          <label for="profile_credits_amount">Кредиты</label>
          <input id="profile_credits_amount" name="credits_amount" type="number" min="1" step="1" placeholder="Например: 5" />
        </div>
        <div id="profile_balance_wrap" style="display:none;">
          <label for="profile_balance_value">Новый баланс</label>
          <input id="profile_balance_value" name="balance_value" type="number" min="0" step="1" placeholder="Например: 100" />
        </div>
        <div id="profile_promo_wrap" style="display:none;">
          <label for="profile_promo_code">Промо-код</label>
          <input id="profile_promo_code" name="promo_code" list="profile_promo_suggestions" placeholder="Например: ABCD1234" />
          {% if active_promo_codes %}
            <datalist id="profile_promo_suggestions">
              {% for code in active_promo_codes %}
                <option value="{{ code }}"></option>
              {% endfor %}
            </datalist>
          {% endif %}
        </div>
      </div>
      <div style="margin-top: 10px;">
        <label for="profile_request_reason">Причина</label>
        <textarea
          id="profile_request_reason"
          name="reason"
          required
          rows="3"
          style="width:100%;padding:8px 10px;border-radius:8px;border:1px solid #2b3f59;background:#0f1b2b;color:var(--text);"
        ></textarea>
      </div>
      <div style="margin-top: 10px; display:flex; gap:10px; flex-wrap: wrap;">
        <button type="submit">Сохранить черновик</button>
        <a class="row-link" href="/admin/change-requests?user_id={{ user.id }}">Открыть список предложений</a>
      </div>
    </form>
  </div>
  <script>
    (function () {
      const typeSelect = document.getElementById("profile_change_type");
      if (!typeSelect) return;
      const creditsWrap = document.getElementById("profile_credits_wrap");
      const balanceWrap = document.getElementById("profile_balance_wrap");
      const promoWrap = document.getElementById("profile_promo_wrap");
      const creditsInput = document.getElementById("profile_credits_amount");
      const balanceInput = document.getElementById("profile_balance_value");
      const promoInput = document.getElementById("profile_promo_code");

      const sync = () => {
        const t = typeSelect.value;
        const isCredits = t === "add_credits" || t === "subtract_credits";
        const isBalance = t === "set_balance";
        const isPromo = t === "revoke_promo";

        creditsWrap.style.display = isCredits ? "" : "none";
        balanceWrap.style.display = isBalance ? "" : "none";
        promoWrap.style.display = isPromo ? "" : "none";

        creditsInput.required = isCredits;
        balanceInput.required = isBalance;
        promoInput.required = isPromo;
      };

      typeSelect.addEventListener("change", sync);
      sync();
    })();
  </script>
  <script>
    (function () {
      const managementSelector = [
        "form[action$='/ban']",
        "form[action$='/unban']",
        "form[action*='/credits/']",
      ].join(", ");
      const actionsSection = document.querySelector(managementSelector)?.closest(".section");
      document.querySelectorAll(managementSelector).forEach((form) => form.remove());
      document
        .querySelectorAll("form[action*='/promos/'][action$='/revoke']")
        .forEach((form) => form.remove());
      if (actionsSection) {
        actionsSection.style.display = "none";
      }
    })();
  </script>
  {% endif %}
{% endblock %}
