from __future__ import annotations

from typing import Dict


SUPPORTED_LANGS = ("ru", "en", "es", "pt", "zh", "fr", "hi", "ja", "tr")


def normalize_lang(code: str | None) -> str:
    if not code:
        return "ru"
    value = code.lower()
    if value.startswith("ru"):
        return "ru"
    if value.startswith("en"):
        return "en"
    if value.startswith("es"):
        return "es"
    if value.startswith("pt"):
        return "pt"
    if value.startswith("zh"):
        return "zh"
    if value.startswith("fr"):
        return "fr"
    if value.startswith("hi"):
        return "hi"
    if value.startswith("ja"):
        return "ja"
    if value.startswith("tr"):
        return "tr"
    return "en"


BASE_RU: Dict[str, str] = {
    # Site
    "site_title": "Renderis Studio",
    "site_tagline": "Генерация изображений прямо в браузере",
    "site_notice": (
        "Результаты на сайте хранятся не более 15 дней. "
        "Все генерации также дублируются в Telegram-боте Renderis Studio."
    ),
    "input_title": "Панель генерации",
    "output_title": "Результат",
    "output_empty": "Пока нет результатов. Запустите генерацию.",
    "download": "Скачать",
    "delete": "Удалить",
    "history_title": "История",
    "balance": "Баланс",
    "credits": "кредитов",
    "redeem": "Промо-код",
    "redeem_placeholder": "Введите промо-код",
    "redeem_button": "Активировать",
    "model_label": "Модель",
    "prompt_label": "Промпт",
    "prompt_placeholder": "Опишите, что нужно создать...",
    "upload_label": "Референсы",
    "upload_hint": "Можно загрузить до 8 изображений (Edit — до 10).",
    "upload_hint_required": "Нужно добавить минимум 1 изображение (до {max}).",
    "upload_hint_optional": "Можно добавить до {max} изображений.",
    "upload_required": "Добавьте хотя бы одно изображение.",
    "upload_count": "Выбрано {count} из {max} файлов.",
    "upload_button": "Добавить файлы",
    "options_label": "Параметры",
    "aspect_ratio": "Соотношение сторон",
    "resolution": "Разрешение",
    "output_format": "Формат",
    "outputs": "Количество",
    "run": "Сгенерировать",
    "run_pending": "Отправляем запрос...",
    "history": "История",
    "history_empty": "Пока нет генераций.",
    "history_deleted": "Файл удалён",
    "logout": "Выйти",
    "login_title": "Вход в Renderis",
    "login_subtitle": "Авторизуйтесь через Telegram, чтобы видеть баланс и историю.",
    "login_failed": "Не удалось авторизоваться.",
    "login_required": "Войдите через Telegram, чтобы продолжить.",
    "prompt_required": "Промпт не может быть пустым.",
    "request_sent": "Запрос отправлен.",
    "error_prefix": "Ошибка",
    "promo_added": "Начислено",
    "promo_error": "Ошибка",
    "delete_failed": "Не удалось удалить",
    "progress_label": "⏳ Прогресс: {pct}%",
    # Ratios / resolutions
    "ratio_1_1": "1:1 (квадрат)",
    "ratio_2_3": "2:3 (портрет)",
    "ratio_3_4": "3:4 (портрет)",
    "ratio_3_2": "3:2 (ландшафт)",
    "ratio_4_3": "4:3 (ландшафт)",
    "ratio_4_5": "4:5 (портрет)",
    "ratio_5_4": "5:4 (ландшафт)",
    "ratio_9_16": "9:16 (портрет)",
    "ratio_16_9": "16:9 (ландшафт)",
    "ratio_21_9": "21:9 (киношный)",
    "ratio_auto": "Auto",
    "res_1k": "1K",
    "res_2k": "2K",
    "res_4k": "4K",
    # Bot menu
    "menu_generate": "🎨 Сгенерировать",
    "menu_buy": "💳 Купить кредиты",
    "menu_prices": "🧮 Арифметика расхода",
    "menu_history": "🕘 История",
    "menu_help": "ℹ️ Помощь",
    "category_choose": "📂 Выберите категорию:",
    "category_images": "🖼️ Изображения",
    "category_video": "🎬 Видео (скоро)",
    "video_soon": "🎬 Видео пока недоступно. Скоро добавим.",
    "model_intro_title": "🖼️ <b>Gemini Images</b>",
    "model_intro_desc": "Создавайте и редактируйте изображения прямо в чате.",
    "model_intro_models": "Для вас работают {count} модели:",
    "model_intro_select": "Выберите модель ниже:",
    "model_not_found": "Модель не найдена",
    "prompt_enter": "✍️ Введите промпт для {model}:",
    "prompt_enter_new": "✍️ Введите новый промпт:",
    "prompt_empty_bot": "Промпт не может быть пустым. Попробуйте еще раз.",
    "prompt_banned": "Запрос содержит запрещенные слова. Измените промпт.",
    "ref_optional": "📎 Можно добавить референсы для более точного результата.\nХотите использовать референсы?",
    "ref_limit": "Достигнут лимит референс-изображений.",
    "ref_required": "Нужно добавить хотя бы одно фото.",
    "ref_required_mode": "Для этого режима нужны референсы.",
    "ref_send_photo": "Пожалуйста, отправьте фото или нажмите «Готово».",
    "ref_done_btn": "✅ Готово",
    "ref_skip_btn": "⏭️ Пропустить",
    "ref_back_btn": "⬅️ Назад",
    "ref_mode_none": "🚫 Без референсов",
    "ref_mode_has": "📎 С референсами",
    "ref_label_photo": "фото",
    "ref_label_ref": "референс-фото",
    "ref_prompt_initial": "📎 Отправьте до {max} {label}.\nКогда закончите, нажмите «Готово».",
    "ref_prompt_more": "✅ Добавлено {count} из {max} фото.\nПришлите еще {label} или нажмите «Готово».",
    "ref_prompt_done": "✅ Добавлено {count} из {max} фото.\nНажмите «Готово».",
    "options_title": "⚙️ <b>Параметры генерации</b>",
    "options_model": "🧠 Модель: {model}",
    "options_prompt": "✍️ Промпт: {prompt}",
    "options_refs": "📎 Референсов: {count}",
    "options_instruction": "Отметьте нужные параметры и нажмите «Далее».",
    "options_next": "➡️ Далее",
    "options_back": "⬅️ Назад",
    "options_count": "— 🔢 Количество —",
    "preview_title": "✅ <b>Проверьте стоимость</b>",
    "preview_model": "🧠 Модель: {model}",
    "preview_prompt": "✍️ Промпт: {prompt}",
    "preview_refs": "📎 Референсов: {count}",
    "preview_outputs": "🔢 Выходов: {count}",
    "preview_cost_per": "💳 Цена за 1: {cost} кр.",
    "preview_total": "🧾 Итого: {total} кр.",
    "preview_discount": "Скидка: {pct}%",
    "preview_notice": "Подтверждая, вы соглашаетесь соблюдать закон и правила сервиса.",
    "confirm_yes": "✅ Подтвердить",
    "confirm_edit_prompt": "✏️ Изменить промпт",
    "confirm_edit_options": "⚙️ Изменить опции",
    "confirm_cancel": "❌ Отмена",
    "cancelled": "❌ Отменено.",
    "task_started": "Задача запущена. Как только будет готово — отправлю результат.",
    "queued": "Сервис перегружен, задача поставлена в очередь. Примерная позиция: {pos}.",
    "api_auth_error": "Ошибка доступа к API. Проверьте ключ Kie.ai.",
    "create_failed": "Не удалось создать задачу. Попробуйте позже.",
    "result_next": "Что дальше?",
    "result_restart": "🆕 Начать заново",
    "result_repeat": "🔁 Повторить",
    "result_finish": "❌ Завершить",
    "result_done": "✅ Завершено. Если хотите еще — нажмите /start.",
    "repeat_prompt": "Отправить запрос повторно?\nБудет списано {cost} кредитов.",
    "repeat_send": "✅ Отправить",
    "repeat_cancel": "❌ Отмена",
    "repeat_cancelled": "Отменено.",
    "error_banned": "Доступ запрещен.",
    "error_outputs": "Недопустимое число вариантов.",
    "error_too_many": "Слишком много активных задач. Подождите завершения текущих.",
    "error_daily_cap": "Достигнут дневной лимит расходов.",
    "error_no_credits": "Недостаточно кредитов. Купите пакет.",
    "error_refs_required": "Для этого режима нужно добавить хотя бы одно фото.",
    "error_generic": "Не удалось запустить генерацию.",
    "help_text": "ℹ️ Это бот для генерации изображений. Используйте меню ниже.\nКоманды: /start /ref CODE /promo CODE /admin (для админов).",
    # Start
    "start_hello": "👋 Привет, {name}!",
    "start_balance": "💰 Баланс: <b>{credits}</b> кредитов.",
    "start_terms": "📜 Используя бот, вы подтверждаете соблюдение законов и правил сервиса.",
    "start_bonus": "Бонус за старт: +{credits} кредитов.",
    # Prices list
    "prices_title": "🧮 <b>Арифметика расхода кредитов</b>",
    "prices_note": "Цены актуальны на момент запроса и меняются мгновенно после правок администратора.",
    "prices_nb": "🍌 Nano Banana — <b>{cost}</b> кр.",
    "prices_edit": "🛠️ Nano Banana Edit — <b>{cost}</b> кр.",
    "prices_pro_no_refs_1k": "⭐ Pro без референсов 1K — <b>{cost}</b> кр.",
    "prices_pro_no_refs_2k": "⭐ Pro без референсов 2K — <b>{cost}</b> кр.",
    "prices_pro_no_refs_4k": "⭐ Pro без референсов 4K — <b>{cost}</b> кр.",
    "prices_pro_refs_1k": "📎 Pro с референсами 1K — <b>{cost}</b> кр.",
    "prices_pro_refs_2k": "📎 Pro с референсами 2K — <b>{cost}</b> кр.",
    "prices_pro_refs_4k": "📎 Pro с референсами 4K — <b>{cost}</b> кр.",
    # History
    "history_user_not_found": "Пользователь не найден.",
    "history_empty_bot": "🕘 История пуста.",
    "history_not_found": "Не найдено",
    "history_no_access": "Недостаточно прав.",
    "history_not_ready": "⏳ Результаты еще не готовы.",
    "history_links_missing": "⚠️ Ссылки не найдены.",
    "history_open_results": "Открыть результаты",
    "history_regen": "Регенерировать",
    "history_regen_started": "✅ Регенерация запущена.",
    "history_created": "Создано",
    # Payments
    "payment_packages_missing": "⚠️ Пакеты не настроены. Обратитесь к администратору.",
    "payment_choose": "💳 Выберите пакет:",
    "payment_package_not_found": "Пакет не найден",
    "payment_invalid": "Некорректный платеж.",
    "payment_processed": "Платеж уже обработан.",
    "payment_success": "Оплата принята. Начислено {credits} кредитов.",
    "payment_user_not_found": "Пользователь не найден.",
    "payment_desc": "{credits} кредитов",
    # Referral / Promo
    "ref_usage": "Использование: /ref CODE",
    "ref_not_found": "Код не найден или неактивен.",
    "ref_already": "Реферальный код уже применён ранее.",
    "ref_applied": "Реферальный код применён. Скидка будет учтена в генерациях.",
    "promo_usage": "Использование: /promo CODE",
    "promo_invalid": "Промо-код не найден или неактивен.",
    "promo_used": "Промо-код уже использован.",
    "promo_not_found": "Промо-код не найден.",
    "promo_activated": "Промо-код активирован. Начислено {credits} кредитов.",
    # Poller / results
    "result_no_urls": "Генерация завершена, но ссылки не получены.",
    "result_original": "Изображение без сжатия",
    "result_caption": "Промпт: {prompt}\nНапишите в чат, если нужно изменить что-то еще.",
    "result_send_failed": "Не удалось отправить результат. Попробуйте позже.",
    "generation_failed": "Генерация не удалась.",
    "generation_failed_reason": "Генерация не удалась. Причина: {reason}",
    "report_thanks": "Спасибо за сообщение! Мы проверим результат.",
}


BASE_EN: Dict[str, str] = {
    "site_title": "Renderis Studio",
    "site_tagline": "Generate images right in your browser",
    "site_notice": "Site results are stored for no more than 15 days. All generations are also delivered in the Renderis Studio Telegram bot.",
    "input_title": "Generation panel",
    "output_title": "Result",
    "output_empty": "No results yet. Start a generation.",
    "download": "Download",
    "delete": "Delete",
    "history_title": "History",
    "balance": "Balance",
    "credits": "credits",
    "redeem": "Promo code",
    "redeem_placeholder": "Enter promo code",
    "redeem_button": "Redeem",
    "model_label": "Model",
    "prompt_label": "Prompt",
    "prompt_placeholder": "Describe what you want to create...",
    "upload_label": "References",
    "upload_hint": "Upload up to 8 images (Edit: up to 10).",
    "upload_hint_required": "At least 1 image required (up to {max}).",
    "upload_hint_optional": "Up to {max} images allowed.",
    "upload_required": "Please add at least one image.",
    "upload_count": "Selected {count} of {max} files.",
    "upload_button": "Add files",
    "options_label": "Options",
    "aspect_ratio": "Aspect ratio",
    "resolution": "Resolution",
    "output_format": "Format",
    "outputs": "Outputs",
    "run": "Run",
    "run_pending": "Sending request...",
    "history": "History",
    "history_empty": "No generations yet.",
    "history_deleted": "File deleted",
    "logout": "Log out",
    "login_title": "Sign in to Renderis",
    "login_subtitle": "Use Telegram login to see your balance and history.",
    "login_failed": "Authorization failed.",
    "login_required": "Please login via Telegram to continue.",
    "prompt_required": "Prompt cannot be empty.",
    "request_sent": "Request sent.",
    "error_prefix": "Error",
    "promo_added": "Added",
    "promo_error": "Error",
    "delete_failed": "Delete failed",
    "progress_label": "⏳ Progress: {pct}%",
    "ratio_1_1": "1:1 (square)",
    "ratio_2_3": "2:3 (portrait)",
    "ratio_3_4": "3:4 (portrait)",
    "ratio_3_2": "3:2 (landscape)",
    "ratio_4_3": "4:3 (landscape)",
    "ratio_4_5": "4:5 (portrait)",
    "ratio_5_4": "5:4 (landscape)",
    "ratio_9_16": "9:16 (portrait)",
    "ratio_16_9": "16:9 (landscape)",
    "ratio_21_9": "21:9 (cinematic)",
    "ratio_auto": "Auto",
    "res_1k": "1K",
    "res_2k": "2K",
    "res_4k": "4K",
    "menu_generate": "🎨 Generate",
    "menu_buy": "💳 Buy credits",
    "menu_prices": "🧮 Credit math",
    "menu_history": "🕘 History",
    "menu_help": "ℹ️ Help",
    "category_choose": "📂 Choose category:",
    "category_images": "🖼️ Images",
    "category_video": "🎬 Video (soon)",
    "video_soon": "🎬 Video is not available yet. Coming soon.",
    "model_intro_title": "🖼️ <b>Gemini Images</b>",
    "model_intro_desc": "Create and edit images right in chat.",
    "model_intro_models": "Available models: {count}",
    "model_intro_select": "Choose a model below:",
    "model_not_found": "Model not found",
    "prompt_enter": "✍️ Enter prompt for {model}:",
    "prompt_enter_new": "✍️ Enter new prompt:",
    "prompt_empty_bot": "Prompt cannot be empty. Try again.",
    "prompt_banned": "Your prompt contains forbidden words. Please edit it.",
    "ref_optional": "📎 You can add references for better results.\nUse references?",
    "ref_limit": "Reference limit reached.",
    "ref_required": "Please add at least one photo.",
    "ref_required_mode": "References are required for this mode.",
    "ref_send_photo": "Please send a photo or tap “Done”.",
    "ref_done_btn": "✅ Done",
    "ref_skip_btn": "⏭️ Skip",
    "ref_back_btn": "⬅️ Back",
    "ref_mode_none": "🚫 No references",
    "ref_mode_has": "📎 With references",
    "ref_label_photo": "photo",
    "ref_label_ref": "reference photo",
    "ref_prompt_initial": "📎 Send up to {max} {label}.\nWhen finished, tap “Done”.",
    "ref_prompt_more": "✅ Added {count} of {max} photos.\nSend more {label} or tap “Done”.",
    "ref_prompt_done": "✅ Added {count} of {max} photos.\nTap “Done”.",
    "options_title": "⚙️ <b>Generation options</b>",
    "options_model": "🧠 Model: {model}",
    "options_prompt": "✍️ Prompt: {prompt}",
    "options_refs": "📎 References: {count}",
    "options_instruction": "Select options and tap “Next”.",
    "options_next": "➡️ Next",
    "options_back": "⬅️ Back",
    "options_count": "— 🔢 Quantity —",
    "preview_title": "✅ <b>Check the cost</b>",
    "preview_model": "🧠 Model: {model}",
    "preview_prompt": "✍️ Prompt: {prompt}",
    "preview_refs": "📎 References: {count}",
    "preview_outputs": "🔢 Outputs: {count}",
    "preview_cost_per": "💳 Cost per 1: {cost} cr.",
    "preview_total": "🧾 Total: {total} cr.",
    "preview_discount": "Discount: {pct}%",
    "preview_notice": "By confirming, you agree to follow the rules and laws.",
    "confirm_yes": "✅ Confirm",
    "confirm_edit_prompt": "✏️ Edit prompt",
    "confirm_edit_options": "⚙️ Edit options",
    "confirm_cancel": "❌ Cancel",
    "cancelled": "❌ Cancelled.",
    "task_started": "Task started. I will send the result when ready.",
    "queued": "Service is busy, task queued. Position: {pos}.",
    "api_auth_error": "API access error. Check Kie.ai key.",
    "create_failed": "Failed to create task. Try again later.",
    "result_next": "What next?",
    "result_restart": "🆕 Start over",
    "result_repeat": "🔁 Repeat",
    "result_finish": "❌ Finish",
    "result_done": "✅ Done. To create more, use /start.",
    "repeat_prompt": "Repeat this request?\nCredits to charge: {cost}.",
    "repeat_send": "✅ Send",
    "repeat_cancel": "❌ Cancel",
    "repeat_cancelled": "Cancelled.",
    "error_banned": "Access denied.",
    "error_outputs": "Invalid output count.",
    "error_too_many": "Too many active tasks. Please wait.",
    "error_daily_cap": "Daily spending limit reached.",
    "error_no_credits": "Not enough credits.",
    "error_refs_required": "This mode requires at least one photo.",
    "error_generic": "Failed to start generation.",
    "help_text": "ℹ️ This bot generates images. Use the menu below.\nCommands: /start /ref CODE /promo CODE /admin (admins).",
    "start_hello": "👋 Hello, {name}!",
    "start_balance": "💰 Balance: <b>{credits}</b> credits.",
    "start_terms": "📜 By using the bot, you agree to follow the rules and laws.",
    "start_bonus": "Signup bonus: +{credits} credits.",
    "prices_title": "🧮 <b>Credit math</b>",
    "prices_note": "Prices are current at the time of request and update instantly after admin changes.",
    "prices_nb": "🍌 Nano Banana — <b>{cost}</b> cr.",
    "prices_edit": "🛠️ Nano Banana Edit — <b>{cost}</b> cr.",
    "prices_pro_no_refs_1k": "⭐ Pro without references 1K — <b>{cost}</b> cr.",
    "prices_pro_no_refs_2k": "⭐ Pro without references 2K — <b>{cost}</b> cr.",
    "prices_pro_no_refs_4k": "⭐ Pro without references 4K — <b>{cost}</b> cr.",
    "prices_pro_refs_1k": "📎 Pro with references 1K — <b>{cost}</b> cr.",
    "prices_pro_refs_2k": "📎 Pro with references 2K — <b>{cost}</b> cr.",
    "prices_pro_refs_4k": "📎 Pro with references 4K — <b>{cost}</b> cr.",
    "history_user_not_found": "User not found.",
    "history_empty_bot": "🕘 History is empty.",
    "history_not_found": "Not found",
    "history_no_access": "Not enough rights.",
    "history_not_ready": "⏳ Results are not ready yet.",
    "history_links_missing": "⚠️ Links not found.",
    "history_open_results": "Open results",
    "history_regen": "Regenerate",
    "history_regen_started": "✅ Regeneration started.",
    "history_created": "Created",
    "payment_packages_missing": "⚠️ Packages are not configured. Contact admin.",
    "payment_choose": "💳 Choose a package:",
    "payment_package_not_found": "Package not found",
    "payment_invalid": "Invalid payment.",
    "payment_processed": "Payment already processed.",
    "payment_success": "Payment received. Credited {credits} credits.",
    "payment_user_not_found": "User not found.",
    "payment_desc": "{credits} credits",
    "ref_usage": "Usage: /ref CODE",
    "ref_not_found": "Code not found or inactive.",
    "ref_already": "Referral code already applied.",
    "ref_applied": "Referral code applied. Discount will be used in generations.",
    "promo_usage": "Usage: /promo CODE",
    "promo_invalid": "Promo code not found or inactive.",
    "promo_used": "Promo code already used.",
    "promo_not_found": "Promo code not found.",
    "promo_activated": "Promo code activated. Added {credits} credits.",
    "result_no_urls": "Generation finished but no URLs returned.",
    "result_original": "Original image",
    "result_caption": "Prompt: {prompt}\nMessage us if you need changes.",
    "result_send_failed": "Failed to send result. Try again later.",
    "generation_failed": "Generation failed.",
    "generation_failed_reason": "Generation failed. Reason: {reason}",
    "report_thanks": "Thanks for the report! We will review the result.",
}


TRANSLATIONS: Dict[str, Dict[str, str]] = {
    "ru": BASE_RU,
    "en": BASE_EN,
    "es": BASE_EN,
    "pt": BASE_EN,
    "zh": BASE_EN,
    "fr": BASE_EN,
    "hi": BASE_EN,
    "ja": BASE_EN,
    "tr": BASE_EN,
}


def t(lang: str, key: str) -> str:
    normalized = normalize_lang(lang)
    return TRANSLATIONS.get(normalized, BASE_RU).get(key, BASE_RU.get(key, key))


def tf(lang: str, key: str, **kwargs: object) -> str:
    return t(lang, key).format(**kwargs)
